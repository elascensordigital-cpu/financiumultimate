<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Financium</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#134a9e">
  <meta name="description" content="Financium: Presente, Archivo, Previsi√≥n, Ahorro y Deudas.">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Financium">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    :root{
      --blue-900:#0b2a5a;
      --blue-700:#134a9e;
      --blue-100:#eaf2ff;
      --shadow: 0 10px 25px rgba(0,0,0,.12);
      --muted:#6b7280;
      --border:#dbe6ff;
      --card:#ffffff;
      --yellow:#ffd23f;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, var(--blue-100), #f7fbff 55%, #ffffff);
      color:#0f172a;
    }

    header{
      position: sticky;
      top:0;
      z-index: 50;
      background: linear-gradient(90deg, var(--blue-900), var(--blue-700));
      box-shadow: var(--shadow);
    }
    .header-inner{
      width: 100%;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .brand{ flex: 1 1 520px; min-width: 0; }
    .brand img{
      width: 100%;
      height: 70px;
      object-fit: cover;
      border-radius: 12px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    main{ max-width:1100px; margin: 0 auto; padding: 16px 14px 40px; }

    .btn{
      border:0;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      background: rgba(255,255,255,.14);
      color: #fff;
      transition: transform .05s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.22); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background: rgba(255,255,255,.10); }
    .btn.primary{ background: #ffffff; color: var(--blue-900); }

    /* Flecha amarilla grande */
    .backArrow{
      border: 0;
      cursor: pointer;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 1000;
      background: var(--yellow);
      color: #1b2a4a;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      font-size: 18px;
      line-height: 1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .backArrow:hover{ filter: brightness(1.03); }
    .backArrow:active{ transform: translateY(1px); }

    .home-grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 14px;
      margin-top: 10px;
    }
    @media (max-width: 1100px){ .home-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width: 720px){ .home-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 520px){ .home-grid{ grid-template-columns: 1fr; } }

    .tile{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 20px rgba(19,74,158,.10);
      padding: 16px;
      display:flex;
      gap: 14px;
      align-items:center;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .15s ease;
    }
    .tile:hover{ transform: translateY(-1px); box-shadow: 0 16px 28px rgba(19,74,158,.14); }

    .tile img{
      width:112px; height:112px;
      object-fit: contain;
      border-radius: 22px;
      background: var(--blue-100);
      padding: 12px;
    }
    .tile strong{ font-size: 20px; color: var(--blue-900); font-weight: 1000; }

    .page{ display:none; }
    .page.active{ display:block; }

    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 26px rgba(11,42,90,.08);
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row > * { flex: 1; min-width: 150px; }
    label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 800; }
    input, select, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid #cfe0ff;
      outline: none;
      background:#fff;
      font-size: 14px;
    }
    textarea{ resize: vertical; min-height: 44px; }
    input:focus, select:focus, textarea:focus{ border-color: #7aa8ff; box-shadow: 0 0 0 4px rgba(122,168,255,.18); }

    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top: 12px; flex-wrap:wrap; }
    .actions .btn{
      background: linear-gradient(90deg, var(--blue-900), var(--blue-700));
      color:#fff;
      padding: 10px 14px;
      border-radius: 12px;
    }
    .actions .btn.light{ background: #ffffff; color: var(--blue-900); border: 1px solid var(--border); }

    .list{ margin-top: 12px; display:flex; flex-direction:column; gap:8px; }

    .item{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      background:#fff;
    }

    .pill{
      font-size: 12px;
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .pill.income{ background: rgba(23,198,193,.20); color: #0b5b58; border: 1px solid rgba(23,198,193,.35); }
    .pill.expense{ background: rgba(255,111,97,.20); color: #7a1f17; border: 1px solid rgba(255,111,97,.35); }

    .item .meta{ flex:1; min-width:0; }
    .concept{ font-weight: 900; color: #0b2a5a; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    .amount{ font-weight: 1000; font-variant-numeric: tabular-nums; white-space:nowrap; }

    .iconBtn{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 1000;
      line-height: 1;
      user-select:none;
    }
    .iconBtn:hover{ background: var(--blue-100); }
    .iconBtn.danger:hover{ background: rgba(231,76,60,.12); border-color: rgba(231,76,60,.25); }
    .iconBtn.coin:hover{ background: rgba(46,204,113,.14); border-color: rgba(46,204,113,.25); }
    .iconBtn.magic:hover{ background: rgba(255,193,7,.18); border-color: rgba(255,193,7,.30); }

    details.archive{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      background:#fff;
    }
    details.archive summary{
      cursor:pointer;
      font-weight: 1000;
      color: var(--blue-900);
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details.archive summary::-webkit-details-marker{ display:none; }
    .archiveTitle{ display:flex; align-items:center; gap:10px; min-width:0; flex:1; }
    .archiveTitle span{ overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }

    .spacer{ height: 10px; }

    .summaryBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 10px 18px rgba(11,42,90,.06);
    }
    .summaryBar .title{
      font-weight:1000;
      color: var(--blue-900);
      font-size: 14px;
    }
    .summaryBar .value{
      font-weight:1000;
      font-variant-numeric: tabular-nums;
      color: #0f172a;
      font-size: 14px;
    }

    /* Archive: checkbox simple */
    .archiveChk{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#fff;
      user-select:none;
    }
    .archiveChk input{ width:auto; margin:0; }

    /* Puzzle button: big piece only */
    .puzzleBtn{
      border: 1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 1000;
      font-size: 18px;
      line-height: 1;
      user-select:none;
    }
    .puzzleBtn:hover{ background: var(--blue-100); }
    .puzzleBtn:active{ transform: translateY(1px); }

    /* Trash actions */
    .trashRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border: 1px dashed rgba(11,42,90,.25);
      border-radius: 16px;
      padding: 10px 12px;
      background:#fff;
    }
    .trashRow .name{
      font-weight:1000;
      color: var(--blue-900);
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .trashRow .meta{
      font-size: 12px;
      font-weight: 900;
      color: #111827;
      opacity: .85;
      white-space:nowrap;
    }

    /* Forecast + Debts (se quedan igual que tu versi√≥n anterior) */
    .forecast-header{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom: 12px; flex-wrap:wrap; }
    .yearBox{ display:flex; flex-direction:column; gap:6px; }
    .yearTitle{ font-weight:1000; color:var(--blue-900); font-size:16px; }
    .yearBalance{ font-weight:1000; color:var(--blue-900); font-size:14px; }
    .months{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; }
    @media (max-width: 900px){ .months{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .month{ border-radius: 16px; padding: 14px 12px; border: 1px solid var(--border); cursor:pointer; box-shadow: 0 10px 18px rgba(11,42,90,.06);
      transition: transform .08s ease, filter .12s ease; display:flex; flex-direction:column; gap:8px; justify-content:center; min-height: 104px; user-select:none; position:relative; overflow:hidden; background:#fff; }
    .month:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .monthName{ font-weight: 1000; color: var(--blue-900); text-align:center; font-size: 15px; }
    .monthBal{ text-align:center; font-weight: 1000; font-variant-numeric: tabular-nums; color:#0f172a; font-size: 14px; }
    .monthTools{ position:absolute; left:10px; top:8px; display:flex; gap:8px; opacity:.98; }
    .monthTools button{ border:1px solid rgba(0,0,0,.10); background: rgba(255,255,255,.80); border-radius: 10px; padding: 6px 8px; cursor:pointer; font-weight: 900; }
    .monthTools button:active{ transform: translateY(1px); }

    .debtCard{ border: 1px solid var(--border); border-radius: 16px; padding: 12px; background: #fff; display:flex; flex-direction:column; gap:10px; }
    .debtTop{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .debtTitle{ font-weight:1000; color: var(--blue-900); font-size: 15px; line-height: 1.25; }
    .debtSub{ font-weight:900; color: #0f172a; font-size: 14px; }
    .debtMeta{ display:flex; gap:10px; flex-wrap:wrap; color: #111827; font-weight: 800; font-size: 12px; }
    .debtMeta span{ background: #f3f7ff; border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; white-space:nowrap; }

    .checks{ display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:8px; }
    @media (max-width: 920px){ .checks{ grid-template-columns: repeat(4, minmax(0,1fr)); } }
    @media (max-width: 520px){ .checks{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    .chk{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; border: 1px solid var(--border);
      border-radius: 12px; padding: 8px; cursor:pointer; background: #fff; user-select:none; font-weight: 900; font-size: 12px; text-align:center; }
    .chk input{ width:auto; }
    .chk.paid{ background: rgba(46,204,113,.12); border-color: rgba(46,204,113,.30); }
    .dateTag{ font-size: 11px; font-weight: 900; color: #0f172a; opacity: .85; font-variant-numeric: tabular-nums; }

    .paidCompact{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; border: 1px solid var(--border);
      border-radius: 16px; padding: 12px; background: #fff; }
    .paidCompact .left{ min-width: 0; flex: 1; display:flex; flex-direction:column; gap:4px; }
    .paidCompact .name{ font-weight: 1000; color: var(--blue-900); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .paidCompact .small{ font-weight: 900; font-size: 12px; color: #111827; opacity: .9; display:flex; gap:8px; flex-wrap:wrap; }
    .paidCompact .small span{ background:#f3f7ff; border:1px solid var(--border); border-radius:999px; padding: 4px 8px; }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 100;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width: min(600px, 100%);
      background:#fff;
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .modalHeader h2{ margin: 0; font-size: 16px; color: var(--blue-900); font-weight: 1000; }
    .modalBody{ margin-top: 8px; }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }
    .modalActions .btn{
      background: linear-gradient(90deg, var(--blue-900), var(--blue-700));
      color:#fff;
    }
    .modalActions .btn.light{
      background:#fff;
      color: var(--blue-900);
      border: 1px solid var(--border);
    }

    .colorGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:10px;
      margin-top:8px;
    }
    .colorSwatch{
      height:38px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      user-select:none;
      padding:0;
    }
    .hint{ font-size:12px; color: var(--muted); margin-top:6px; }
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <img src="./cabecera.png" alt="Financium" onerror="this.style.display='none'">
    </div>

    <div class="top-actions">
      <button id="btnShareBackup" class="btn secondary" title="Compartir o descargar tu backup">üì§ Backup</button>
      <button id="btnImportBackup" class="btn secondary" title="Importar un backup">üì• Importar</button>
      <input id="fileImportBackup" type="file" accept="application/json" style="display:none">

      <button id="btnBackHome" class="backArrow" style="display:none" title="Volver">‚¨ÖÔ∏è</button>
      <button id="btnArchivarTop" class="btn primary" style="display:none">üì¶ Archivar</button>
    </div>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="pageHome" class="page active">
    <div class="home-grid">
      <div class="tile" data-nav="present">
        <img src="./presente.png" alt="Presente" onerror="this.style.display='none'">
        <strong>Presente</strong>
      </div>

      <div class="tile" data-nav="archive">
        <img src="./archivo.png" alt="Archivo" onerror="this.style.display='none'">
        <strong>Archivo</strong>
      </div>

      <div class="tile" data-nav="forecast">
        <img src="./prevision.png" alt="Previsi√≥n" onerror="this.style.display='none'">
        <strong>Previsi√≥n</strong>
      </div>

      <div class="tile" data-nav="savings">
        <img src="./ahorro.png" alt="Ahorro" onerror="this.style.display='none'">
        <strong>Ahorro</strong>
      </div>

      <div class="tile" data-nav="debts">
        <img src="./deudas.png" alt="Deudas" onerror="this.style.display='none'">
        <strong>Deudas</strong>
      </div>
    </div>
  </section>

  <!-- PRESENT -->
  <section id="pagePresent" class="page">
    <div class="panel">
      <div class="row">
        <div>
          <label for="pAmount">Cantidad</label>
          <input id="pAmount" type="number" step="0.01" inputmode="decimal" placeholder="0,00" />
        </div>
        <div>
          <label for="pConcept">Concepto</label>
          <input id="pConcept" type="text" />
        </div>
        <div>
          <label for="pType">Tipo</label>
          <select id="pType">
            <option value="income">Ingreso</option>
            <option value="expense">Gasto</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="btnAddPresent" class="btn">‚ûï A√±adir</button>
        <button id="btnClearPresent" class="btn light">üßπ Limpiar</button>
      </div>

      <div class="list" id="presentList"></div>
    </div>
  </section>

  <!-- AHORRO -->
  <section id="pageSavings" class="page">
    <div class="panel">
      <div class="summaryBar">
        <div class="title">Total acumulado</div>
        <div class="value" id="savingsTotal">0,00 ‚Ç¨</div>
      </div>

      <div class="list" id="savingsList"></div>
      <div class="spacer"></div>
      <div class="actions">
        <button id="btnClearSavings" class="btn light">üßπ Limpiar</button>
      </div>
    </div>
  </section>

  <!-- ARCHIVE -->
  <section id="pageArchive" class="page">
    <div class="panel">
      <div class="summaryBar" style="margin-bottom:12px;">
        <div class="title">Archivo</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;">
          <!-- ‚úÖ solo puzzle grande (sin texto) -->
          <button id="btnGroupPuzzle" class="puzzleBtn" title="Agrupar seleccionados">üß©</button>
        </div>
      </div>

      <!-- Grupos -->
      <div class="list" id="archiveGroupsList"></div>

      <div class="spacer"></div>

      <!-- Archivos (sueltos) -->
      <div class="list" id="archiveList"></div>

      <div class="spacer"></div>

      <!-- Papelera -->
      <details class="archive">
        <summary>
          <div class="archiveTitle"><span>Papelera</span></div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button id="btnTrashWipeAll" class="iconBtn" title="Borrar definitivamente todo">üßΩ</button>
          </div>
        </summary>
        <div class="list" id="trashList" style="margin-top:10px;"></div>
      </details>

      <div class="spacer"></div>

      <div class="actions">
        <button id="btnExport" class="btn light">‚¨áÔ∏è Exportar</button>
        <button id="btnImport" class="btn light">‚¨ÜÔ∏è Importar</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none">
    </div>
  </section>

  <!-- FORECAST -->
  <section id="pageForecast" class="page">
    <div class="panel">
      <div class="forecast-header">
        <div class="yearBox">
          <div class="yearTitle"><span id="yearLabel"></span></div>
          <div class="yearBalance">Balance anual: <span id="yearBalance"></span></div>
        </div>
      </div>
      <div class="months" id="monthsGrid"></div>
    </div>
  </section>

  <!-- FORECAST MONTH DETAIL -->
  <section id="pageForecastMonth" class="page">
    <div class="panel">
      <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:1000;color:var(--blue-900);font-size:16px" id="monthTitle"></div>
        <div style="display:flex;gap:10px;align-items:center;">
          <button id="btnMonthColor" class="btn" style="background:#fff;color:var(--blue-900);border:1px solid var(--border);">üé® Color</button>
          <button id="btnBackForecast" class="btn" style="background:#fff;color:var(--blue-900);border:1px solid var(--border);">‚¨ÖÔ∏è</button>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="row">
        <div>
          <label for="fAmount">Cantidad</label>
          <input id="fAmount" type="number" step="0.01" inputmode="decimal" placeholder="0,00" />
        </div>
        <div>
          <label for="fConcept">Concepto</label>
          <input id="fConcept" type="text" />
        </div>
        <div>
          <label for="fType">Tipo</label>
          <select id="fType">
            <option value="income">Ingreso</option>
            <option value="expense">Gasto</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="btnAddForecast" class="btn">‚ûï A√±adir</button>
        <button id="btnClearForecastMonth" class="btn light">üßπ Limpiar</button>
      </div>

      <div class="list" id="forecastMonthList"></div>
    </div>
  </section>

  <!-- DEUDAS -->
  <section id="pageDebts" class="page">
    <div class="panel">
      <div class="row">
        <div>
          <label for="dEntity">Persona / Entidad</label>
          <input id="dEntity" type="text" placeholder="Ej: Banco, Mar√≠a, etc." />
        </div>
        <div>
          <label for="dTotal">Importe total</label>
          <input id="dTotal" type="number" step="0.01" inputmode="decimal" placeholder="0,00" />
        </div>
        <div>
          <label for="dInstallment">Cuota</label>
          <input id="dInstallment" type="number" step="0.01" inputmode="decimal" placeholder="0,00" />
        </div>
        <div>
          <label for="dMonths">N¬∫ de cuotas</label>
          <input id="dMonths" type="number" step="1" inputmode="numeric" placeholder="12" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="flex: 1 1 100%;">
          <label for="dNote">Nota (opcional)</label>
          <textarea id="dNote" placeholder="Ej: pr√©stamo coche, acuerdo, etc."></textarea>
        </div>
      </div>

      <div class="actions">
        <button id="btnAddDebt" class="btn">‚ûï A√±adir deuda</button>
        <button id="btnClearDebts" class="btn light">üßπ Limpiar deudas</button>
      </div>

      <div class="spacer"></div>

      <details class="archive" open>
        <summary>
          <div class="archiveTitle"><span>Deudas activas</span></div>
          <div></div>
        </summary>
        <div class="list" id="debtsActiveList" style="margin-top:10px;"></div>
      </details>

      <div class="spacer"></div>

      <details class="archive">
        <summary>
          <div class="archiveTitle"><span>Deudas ya pagadas</span></div>
          <div></div>
        </summary>
        <div class="list" id="debtsPaidList" style="margin-top:10px;"></div>
      </details>
    </div>
  </section>
</main>

<!-- MODAL -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <div class="modalHeader">
      <h2 id="modalTitle"></h2>
      <button id="btnModalCloseX" class="iconBtn" aria-label="Cerrar">‚úï</button>
    </div>
    <div id="modalBody" class="modalBody"></div>
    <div class="modalActions">
      <button id="btnModalCancel" class="btn light">Cancelar</button>
      <button id="btnModalOk" class="btn">Guardar</button>
    </div>
  </div>
</div>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }

  const fmtEUR = (n) => new Intl.NumberFormat('es-ES', { style:'currency', currency:'EUR' }).format(Number(n||0));
  const nowISO = () => new Date().toISOString();
  const todayISODate = () => new Date().toISOString().slice(0,10);
  const uid = () => Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  const MONTHS_ES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  /* ‚úÖ nuevo esquema con grupos + papelera */
  const STORAGE_KEY = "financium_state_v9";

  function normalizeItem(it){
    return {
      id: it.id || uid(),
      amount: Number(it.amount || 0),
      concept: String(it.concept || ""),
      type: (it.type === "expense" ? "expense" : "income"),
      createdAt: it.createdAt || nowISO()
    };
  }

  function normalizeDebt(d){
    const count = Math.max(1, Math.floor(Number(d.installmentsCount || 1)));
    let payments = Array.isArray(d.payments) ? d.payments.slice(0, count).map(Boolean) : [];
    while(payments.length < count) payments.push(false);

    let paymentDates = Array.isArray(d.paymentDates) ? d.paymentDates.slice(0, count).map(x => x ? String(x) : "") : [];
    while(paymentDates.length < count) paymentDates.push("");

    return {
      id: d.id || uid(),
      entity: String(d.entity || ""),
      total: Number(d.total || 0),
      installmentAmount: Number(d.installmentAmount || 0),
      installmentsCount: count,
      note: String(d.note || ""),
      payments,
      paymentDates,
      createdAt: d.createdAt || nowISO()
    };
  }

  function normalizeArchive(a){
    return {
      id: a.id || uid(),
      name: String(a.name || "Archivo"),
      createdAt: a.createdAt || nowISO(),
      items: (a.items || []).map(normalizeItem)
    };
  }

  function normalizeGroup(g){
    const ids = Array.isArray(g.archiveIds) ? g.archiveIds.map(String) : [];
    return {
      id: g.id || uid(),
      name: String(g.name || "Grupo"),
      archiveIds: Array.from(new Set(ids)),
      createdAt: g.createdAt || nowISO()
    };
  }

  function normalizeTrash(t){
    // t es un archive normal con deletedAt
    const a = normalizeArchive(t);
    return { ...a, deletedAt: t.deletedAt || nowISO() };
  }

  function emptyState(){
    const year = new Date().getFullYear();
    return {
      present: [],
      savings: [],
      archives: [],
      archiveGroups: [],      // ‚úÖ agrupaciones (no contienen items; apuntan a IDs)
      trashArchives: [],      // ‚úÖ papelera
      forecast: { [year]: {} },
      monthColors: { [year]: {} },
      debts: { active: [], paid: [] }
    };
  }

  function loadState(){
    const year = new Date().getFullYear();
    const base = emptyState();
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return base;
      const s = JSON.parse(raw);

      if(!Array.isArray(s.present)) s.present = [];
      if(!Array.isArray(s.savings)) s.savings = [];
      if(!Array.isArray(s.archives)) s.archives = [];
      if(!Array.isArray(s.archiveGroups)) s.archiveGroups = [];         // ‚úÖ
      if(!Array.isArray(s.trashArchives)) s.trashArchives = [];         // ‚úÖ

      if(!s.forecast || typeof s.forecast !== "object") s.forecast = base.forecast;
      if(!s.monthColors || typeof s.monthColors !== "object") s.monthColors = base.monthColors;
      if(!s.debts || typeof s.debts !== "object") s.debts = base.debts;
      if(!Array.isArray(s.debts.active)) s.debts.active = [];
      if(!Array.isArray(s.debts.paid)) s.debts.paid = [];

      if(!s.forecast[year]) s.forecast[year] = {};
      if(!s.monthColors[year]) s.monthColors[year] = {};

      s.present = s.present.map(normalizeItem);
      s.savings = s.savings.map(normalizeItem);
      s.archives = s.archives.map(normalizeArchive);
      s.archiveGroups = s.archiveGroups.map(normalizeGroup);
      s.trashArchives = s.trashArchives.map(normalizeTrash);

      for(const y of Object.keys(s.forecast)){
        const obj = s.forecast[y] || {};
        for(const m of Object.keys(obj)){
          obj[m] = (obj[m] || []).map(normalizeItem);
        }
        s.forecast[y] = obj;
      }

      s.debts.active = s.debts.active.map(normalizeDebt);
      s.debts.paid = s.debts.paid.map(normalizeDebt);

      // Limpieza: quitar IDs de grupos que ya no existan
      const archiveIdSet = new Set(s.archives.map(a => a.id));
      s.archiveGroups.forEach(g=>{
        g.archiveIds = g.archiveIds.filter(id => archiveIdSet.has(id));
      });
      s.archiveGroups = s.archiveGroups.filter(g => g.archiveIds.length > 0);

      return s;
    }catch(e){
      return base;
    }
  }

  let state = loadState();
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  /* =========================
     Backup manual (opci√≥n 1)
     ========================= */
  const btnShareBackup = document.getElementById("btnShareBackup");
  const btnImportBackup = document.getElementById("btnImportBackup");
  const fileImportBackup = document.getElementById("fileImportBackup");

  btnShareBackup.addEventListener("click", async ()=>{
    const raw = localStorage.getItem(STORAGE_KEY);
    const data = raw ? raw : JSON.stringify(emptyState());
    const blob = new Blob([data], { type:"application/json" });
    const file = new File([blob], "financium_backup.json", { type:"application/json" });

    if(navigator.share && navigator.canShare && navigator.canShare({ files:[file] })){
      try{
        await navigator.share({ files:[file], title:"Financium backup", text:"Backup de Financium" });
        return;
      }catch(e){}
    }

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "financium_backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  btnImportBackup.addEventListener("click", ()=> fileImportBackup.click());

  fileImportBackup.addEventListener("change", async ()=>{
    const file = fileImportBackup.files && fileImportBackup.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      JSON.parse(text);
      localStorage.setItem(STORAGE_KEY, text);
      alert("Backup importado. Se recargar√° la app.");
      location.reload();
    }catch(e){
      alert("Archivo inv√°lido.");
    }finally{
      fileImportBackup.value = "";
    }
  });

  /* =========================
     Modal gen√©rico
     ========================= */
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const btnModalOk = document.getElementById("btnModalOk");
  const btnModalCancel = document.getElementById("btnModalCancel");
  const btnModalCloseX = document.getElementById("btnModalCloseX");
  let modalOnOk = null;

  function closeModal(){
    modalBackdrop.classList.remove("show");
    modalTitle.textContent = "";
    modalBody.innerHTML = "";
    modalOnOk = null;
  }
  function openModal({ title, bodyNode, okText="Guardar", cancelText="Cancelar", onOk }){
    modalTitle.textContent = title;
    modalBody.innerHTML = "";
    modalBody.appendChild(bodyNode);
    btnModalOk.textContent = okText;

    if(String(cancelText||"") === ""){
      btnModalCancel.style.display = "none";
    }else{
      btnModalCancel.style.display = "inline-flex";
      btnModalCancel.textContent = cancelText;
    }

    modalOnOk = onOk;
    modalBackdrop.classList.add("show");

    setTimeout(()=>{
      const f = modalBody.querySelector("input, textarea, select, button");
      if(f && f.focus) f.focus();
      if(f && f.select) f.select();
    }, 0);
  }
  btnModalCancel.addEventListener("click", closeModal);
  btnModalCloseX.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e)=>{ if(e.target === modalBackdrop) closeModal(); });
  btnModalOk.addEventListener("click", async ()=>{
    if(typeof modalOnOk === "function"){
      const ok = await modalOnOk();
      if(ok !== false) closeModal();
    }else closeModal();
  });

  function openTextModal({ title, initialValue, okText, onOk }){
    const box = document.createElement("div");
    box.innerHTML = `<label>Nombre</label>`;
    const inp = document.createElement("input");
    inp.type = "text";
    inp.value = initialValue || "";
    box.appendChild(inp);

    openModal({
      title, bodyNode: box,
      okText, cancelText: "Cancelar",
      onOk: ()=>{
        const v = String(inp.value||"").trim();
        if(!v){ inp.focus(); return false; }
        onOk(v);
        return true;
      }
    });
  }

  function computeBalance(items){
    let income = 0, expense = 0;
    for(const it of items){
      const v = Number(it.amount || 0);
      if(it.type === "income") income += v;
      else expense += v;
    }
    return { income, expense, balance: income - expense };
  }

  /* =========================
     Navegaci√≥n
     ========================= */
  const pages = {
    home: document.getElementById("pageHome"),
    present: document.getElementById("pagePresent"),
    savings: document.getElementById("pageSavings"),
    archive: document.getElementById("pageArchive"),
    forecast: document.getElementById("pageForecast"),
    forecastMonth: document.getElementById("pageForecastMonth"),
    debts: document.getElementById("pageDebts"),
  };

  const btnBackHome = document.getElementById("btnBackHome");
  const btnArchivarTop = document.getElementById("btnArchivarTop");
  let currentForecastMonth = null;

  function setTopButtons(view){
    btnBackHome.style.display = (view === "home") ? "none" : "inline-flex";
    btnArchivarTop.style.display = (view === "present") ? "inline-flex" : "none";
  }
  function showPage(view){
    Object.values(pages).forEach(p => p.classList.remove("active"));
    pages[view].classList.add("active");
    setTopButtons(view);

    if(view === "present") renderPresent();
    if(view === "savings") renderSavings();
    if(view === "archive") renderArchive();
    if(view === "forecast") renderForecast();
    if(view === "forecastMonth") renderForecastMonth();
    if(view === "debts") renderDebts();
  }

  document.querySelectorAll(".tile").forEach(tile=>{
    tile.addEventListener("click", ()=>{
      const nav = tile.dataset.nav;
      if(nav) showPage(nav);
    });
  });
  btnBackHome.addEventListener("click", ()=> showPage("home"));

  /* =========================
     Movimientos
     ========================= */
  function openEditMovementModal(item, onSave){
    const wrap = document.createElement("div");
    wrap.className = "row";

    const a = document.createElement("div");
    a.innerHTML = `<label>Cantidad</label>`;
    const inpAmount = document.createElement("input");
    inpAmount.type = "number";
    inpAmount.step = "0.01";
    inpAmount.inputMode = "decimal";
    inpAmount.value = String(item.amount ?? 0);
    a.appendChild(inpAmount);

    const b = document.createElement("div");
    b.innerHTML = `<label>Concepto</label>`;
    const inpConcept = document.createElement("input");
    inpConcept.type = "text";
    inpConcept.value = item.concept || "";
    b.appendChild(inpConcept);

    const c = document.createElement("div");
    c.innerHTML = `<label>Tipo</label>`;
    const selType = document.createElement("select");
    selType.innerHTML = `<option value="income">Ingreso</option><option value="expense">Gasto</option>`;
    selType.value = item.type || "income";
    c.appendChild(selType);

    wrap.appendChild(a); wrap.appendChild(b); wrap.appendChild(c);

    openModal({
      title: "Editar movimiento",
      bodyNode: wrap,
      okText: "Guardar",
      cancelText: "Cancelar",
      onOk: ()=>{
        const n = Number(String(inpAmount.value).replace(",", "."));
        const concept = String(inpConcept.value||"").trim();
        if(!Number.isFinite(n)){ inpAmount.focus(); return false; }
        if(!concept){ inpConcept.focus(); return false; }
        item.amount = n;
        item.concept = concept;
        item.type = selType.value;
        saveState();
        onSave();
        return true;
      }
    });
  }

  function renderMovementRow(item, { onRefresh, onDelete, showCoin=false, onCoin=null }){
    const row = document.createElement("div");
    row.className = "item";

    const pill = document.createElement("div");
    pill.className = "pill " + (item.type === "expense" ? "expense" : "income");
    pill.textContent = item.type === "expense" ? "Gasto" : "Ingreso";

    const meta = document.createElement("div");
    meta.className = "meta";
    const concept = document.createElement("div");
    concept.className = "concept";
    concept.textContent = item.concept || "";
    meta.appendChild(concept);

    const amount = document.createElement("div");
    amount.className = "amount";
    amount.textContent = fmtEUR(item.amount);

    row.appendChild(pill);
    row.appendChild(meta);
    row.appendChild(amount);

    if(showCoin){
      const coin = document.createElement("button");
      coin.className = "iconBtn coin";
      coin.title = "Pasar a Ahorro";
      coin.textContent = "ü™ô";
      coin.addEventListener("click", ()=> onCoin && onCoin());
      row.appendChild(coin);
    }

    const edit = document.createElement("button");
    edit.className = "iconBtn";
    edit.title = "Editar";
    edit.textContent = "‚úèÔ∏è";
    edit.addEventListener("click", ()=> openEditMovementModal(item, onRefresh));

    const del = document.createElement("button");
    del.className = "iconBtn danger";
    del.title = "Borrar";
    del.textContent = "üóëÔ∏è";
    del.addEventListener("click", ()=>{
      openModal({
        title:"Borrar movimiento",
        bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øSeguro?"; return d;})(),
        okText:"Borrar",
        cancelText:"Cancelar",
        onOk: ()=>{ onDelete(); return true; }
      });
    });

    row.appendChild(edit);
    row.appendChild(del);
    return row;
  }

  /* =========================
     Presente
     ========================= */
  const pAmount = document.getElementById("pAmount");
  const pConcept = document.getElementById("pConcept");
  const pType = document.getElementById("pType");
  const btnAddPresent = document.getElementById("btnAddPresent");
  const btnClearPresent = document.getElementById("btnClearPresent");
  const presentList = document.getElementById("presentList");

  btnAddPresent.addEventListener("click", ()=>{
    const amount = Number(String(pAmount.value).replace(",", "."));
    const concept = String(pConcept.value||"").trim();
    const type = pType.value;

    if(!Number.isFinite(amount) || amount === 0) return;
    if(!concept) return;

    state.present.unshift(normalizeItem({ amount, concept, type, createdAt: nowISO() }));
    saveState();

    pAmount.value = "";
    pConcept.value = "";
    pType.value = "income";
    renderPresent();
  });

  btnClearPresent.addEventListener("click", ()=>{
    if(!state.present.length) return;
    openModal({
      title:"Limpiar",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øBorrar todos los movimientos?"; return d;})(),
      okText:"Borrar",
      cancelText:"Cancelar",
      onOk: ()=>{ state.present = []; saveState(); renderPresent(); return true; }
    });
  });

  function openMoveToSavingsModal(presentItem, onMoved){
    const max = Number(presentItem.amount || 0);
    const box = document.createElement("div");
    box.innerHTML = `<label>Cantidad a pasar a ahorro</label>`;
    const inp = document.createElement("input");
    inp.type = "number";
    inp.step = "0.01";
    inp.inputMode = "decimal";
    inp.min = "0";
    inp.max = String(max);
    inp.value = String(max);
    box.appendChild(inp);

    openModal({
      title: "Pasar a Ahorro",
      bodyNode: box,
      okText: "Mover",
      cancelText: "Cancelar",
      onOk: ()=>{
        const n = Number(String(inp.value).replace(",", "."));
        if(!Number.isFinite(n) || n <= 0){ inp.focus(); return false; }
        if(n > max){ inp.focus(); return false; }

        presentItem.amount = +(max - n).toFixed(2);
        if(presentItem.amount <= 0.000001){
          state.present = state.present.filter(x => x.id !== presentItem.id);
        }

        state.savings.unshift(normalizeItem({
          amount: +n.toFixed(2),
          concept: presentItem.concept,
          type: "income",
          createdAt: nowISO()
        }));

        saveState();
        onMoved();
        return true;
      }
    });
  }

  function renderPresent(){
    presentList.innerHTML = "";
    state.present.forEach(it=>{
      presentList.appendChild(renderMovementRow(it, {
        onRefresh: renderPresent,
        onDelete: ()=>{ state.present = state.present.filter(x => x.id !== it.id); saveState(); renderPresent(); },
        showCoin: true,
        onCoin: ()=> openMoveToSavingsModal(it, ()=>{ renderPresent(); renderSavings(); })
      }));
    });
  }

  /* =========================
     Archivar
     ========================= */
  btnArchivarTop.addEventListener("click", ()=>{
    if(!state.present.length) return;
    openTextModal({
      title:"Nombre del archivo",
      initialValue:"Archivo " + new Date().toLocaleDateString("es-ES"),
      okText:"Archivar",
      onOk:(name)=>{
        state.archives.unshift({ id: uid(), name, createdAt: nowISO(), items: state.present.map(x=>({ ...x })) });
        state.present = [];
        saveState();
        renderPresent();
        renderArchive();
      }
    });
  });

  /* =========================
     Ahorro (total arriba)
     ========================= */
  const savingsList = document.getElementById("savingsList");
  const savingsTotalEl = document.getElementById("savingsTotal");
  const btnClearSavings = document.getElementById("btnClearSavings");

  btnClearSavings.addEventListener("click", ()=>{
    if(!state.savings.length) return;
    openModal({
      title:"Limpiar",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øBorrar todos los movimientos de Ahorro?"; return d;})(),
      okText:"Borrar",
      cancelText:"Cancelar",
      onOk: ()=>{ state.savings = []; saveState(); renderSavings(); return true; }
    });
  });

  function renderSavings(){
    const total = state.savings.reduce((acc, it)=> acc + Number(it.amount||0), 0);
    savingsTotalEl.textContent = fmtEUR(total);

    savingsList.innerHTML = "";
    state.savings.forEach(it=>{
      savingsList.appendChild(renderMovementRow(it, {
        onRefresh: renderSavings,
        onDelete: ()=>{ state.savings = state.savings.filter(x => x.id !== it.id); saveState(); renderSavings(); },
        showCoin:false
      }));
    });
  }

  /* =========================
     ARCHIVO: grupos + papelera + borrar seguro
     ========================= */
  const archiveGroupsList = document.getElementById("archiveGroupsList");
  const archiveList = document.getElementById("archiveList");
  const trashList = document.getElementById("trashList");
  const btnTrashWipeAll = document.getElementById("btnTrashWipeAll");

  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");
  const importFile = document.getElementById("importFile");

  const btnGroupPuzzle = document.getElementById("btnGroupPuzzle");

  // ‚úÖ selecci√≥n sin texto (solo checkbox)
  const selectedArchiveIds = new Set();

  function groupedIdSet(){
    const set = new Set();
    state.archiveGroups.forEach(g => g.archiveIds.forEach(id => set.add(id)));
    return set;
  }

  function removeArchiveIdFromGroups(archiveId){
    state.archiveGroups.forEach(g=>{
      g.archiveIds = g.archiveIds.filter(id => id !== archiveId);
    });
    state.archiveGroups = state.archiveGroups.filter(g => g.archiveIds.length > 0);
  }

  function openDeleteGroupModal(group){
    openModal({
      title:"Eliminar agrupaci√≥n",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent=`Se eliminar√° el grupo "${group.name}", pero los archivos seguir√°n existiendo. ¬øContinuar?`; return d;})(),
      okText:"Eliminar",
      cancelText:"Cancelar",
      onOk: ()=>{
        state.archiveGroups = state.archiveGroups.filter(g => g.id !== group.id);
        saveState();
        renderArchive();
        return true;
      }
    });
  }

  function moveArchiveToTrash(archive){
    // quitar de grupos
    removeArchiveIdFromGroups(archive.id);
    // quitar de lista principal
    state.archives = state.archives.filter(a => a.id !== archive.id);
    // enviar a papelera
    state.trashArchives.unshift({ ...archive, deletedAt: nowISO() });
    saveState();
  }

  function permanentlyDeleteTrashArchive(trashId){
    state.trashArchives = state.trashArchives.filter(t => t.id !== trashId);
    saveState();
  }

  function renderTrash(){
    trashList.innerHTML = "";

    if(!state.trashArchives.length){
      const d = document.createElement("div");
      d.style.color = "var(--muted)";
      d.style.fontWeight = "800";
      d.style.fontSize = "13px";
      d.textContent = "Vac√≠a";
      trashList.appendChild(d);
      return;
    }

    state.trashArchives.forEach(t=>{
      const row = document.createElement("div");
      row.className = "trashRow";

      const left = document.createElement("div");
      left.style.minWidth = "0";
      left.style.flex = "1";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = t.name;

      const meta = document.createElement("div");
      meta.className = "meta";
      const when = (t.deletedAt || "").slice(0,10);
      meta.textContent = `Borrado: ${when || "-"}`;

      left.appendChild(name);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.alignItems = "center";

      // ‚úÖ borrar definitivo con goma
      const wipe = document.createElement("button");
      wipe.className = "iconBtn";
      wipe.title = "Borrar definitivamente";
      wipe.textContent = "üßΩ";
      wipe.addEventListener("click", ()=>{
        openModal({
          title:"Borrar definitivamente",
          bodyNode:(()=>{const d=document.createElement("div"); d.textContent=`Esto eliminar√° "${t.name}" para siempre. ¬øContinuar?`; return d;})(),
          okText:"Borrar",
          cancelText:"Cancelar",
          onOk: ()=>{
            permanentlyDeleteTrashArchive(t.id);
            renderTrash();
            return true;
          }
        });
      });

      right.appendChild(wipe);

      row.appendChild(left);
      row.appendChild(right);
      trashList.appendChild(row);
    });
  }

  btnTrashWipeAll.addEventListener("click", ()=>{
    if(!state.trashArchives.length) return;
    openModal({
      title:"Vaciar papelera",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent="Esto borrar√° definitivamente TODO lo que hay en la papelera. ¬øContinuar?"; return d;})(),
      okText:"Vaciar",
      cancelText:"Cancelar",
      onOk: ()=>{
        state.trashArchives = [];
        saveState();
        renderTrash();
        return true;
      }
    });
  });

  // ‚úÖ puzzle: agrupar seleccionados (sin fusionar archivos)
  btnGroupPuzzle.addEventListener("click", ()=>{
    const ids = Array.from(selectedArchiveIds);
    if(ids.length < 2){
      const d = document.createElement("div");
      d.textContent = "Marca al menos 2 archivos para agrupar.";
      openModal({ title:"Agrupar", bodyNode:d, okText:"OK", cancelText:"", onOk: ()=>true });
      return;
    }

    openTextModal({
      title:"Nombre del grupo",
      initialValue: new Date().getFullYear().toString(),
      okText:"Crear grupo",
      onOk:(name)=>{
        state.archiveGroups.unshift({
          id: uid(),
          name,
          archiveIds: ids,
          createdAt: nowISO()
        });
        selectedArchiveIds.clear();
        saveState();
        renderArchive();
      }
    });
  });

  function renderArchive(){
    archiveGroupsList.innerHTML = "";
    archiveList.innerHTML = "";

    const gSet = groupedIdSet();

    // ====== GRUPOS ======
    state.archiveGroups.forEach(group=>{
      const det = document.createElement("details");
      det.className = "archive";

      const sum = document.createElement("summary");

      const left = document.createElement("div");
      left.className = "archiveTitle";

      const nameSpan = document.createElement("span");
      nameSpan.textContent = group.name;

      left.appendChild(nameSpan);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.alignItems = "center";

      // renombrar grupo
      const rename = document.createElement("button");
      rename.className = "iconBtn";
      rename.title = "Renombrar grupo";
      rename.textContent = "‚úèÔ∏è";
      rename.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        openTextModal({
          title:"Renombrar grupo",
          initialValue: group.name,
          okText:"Guardar",
          onOk:(newName)=>{
            group.name = newName;
            saveState();
            renderArchive();
          }
        });
      });

      // borrar grupo (solo agrupaci√≥n)
      const delGroup = document.createElement("button");
      delGroup.className = "iconBtn danger";
      delGroup.title = "Eliminar agrupaci√≥n";
      delGroup.textContent = "üóëÔ∏è";
      delGroup.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        openDeleteGroupModal(group);
      });

      right.appendChild(rename);
      right.appendChild(delGroup);

      sum.appendChild(left);
      sum.appendChild(right);
      det.appendChild(sum);

      const inner = document.createElement("div");
      inner.style.marginTop = "10px";
      inner.style.display = "flex";
      inner.style.flexDirection = "column";
      inner.style.gap = "8px";

      // renderizar archivos dentro del grupo
      group.archiveIds.forEach(aid=>{
        const arch = state.archives.find(a => a.id === aid);
        if(!arch) return;

        const aDet = document.createElement("details");
        aDet.className = "archive";

        const aSum = document.createElement("summary");

        const aLeft = document.createElement("div");
        aLeft.className = "archiveTitle";

        const aName = document.createElement("span");
        aName.textContent = arch.name;

        aLeft.appendChild(aName);

        const aRight = document.createElement("div");
        aRight.style.display = "flex";
        aRight.style.gap = "8px";
        aRight.style.alignItems = "center";

        // renombrar archivo
        const aRename = document.createElement("button");
        aRename.className = "iconBtn";
        aRename.textContent = "‚úèÔ∏è";
        aRename.title = "Renombrar archivo";
        aRename.addEventListener("click", (e)=>{
          e.preventDefault(); e.stopPropagation();
          openTextModal({
            title:"Renombrar archivo",
            initialValue: arch.name,
            okText:"Guardar",
            onOk:(newName)=>{
              arch.name = newName;
              saveState();
              renderArchive();
            }
          });
        });

        // borrar archivo -> papelera
        const aDel = document.createElement("button");
        aDel.className = "iconBtn danger";
        aDel.textContent = "üóëÔ∏è";
        aDel.title = "Borrar (a papelera)";
        aDel.addEventListener("click", (e)=>{
          e.preventDefault(); e.stopPropagation();
          openModal({
            title:"Borrar archivo",
            bodyNode:(()=>{const d=document.createElement("div"); d.textContent=`¬øSeguro que quieres borrar "${arch.name}"? Se enviar√° a la papelera.`; return d;})(),
            okText:"Borrar",
            cancelText:"Cancelar",
            onOk: ()=>{
              moveArchiveToTrash(arch);
              renderArchive();
              renderTrash();
              return true;
            }
          });
        });

        aRight.appendChild(aRename);
        aRight.appendChild(aDel);

        aSum.appendChild(aLeft);
        aSum.appendChild(aRight);
        aDet.appendChild(aSum);

        const itemsWrap = document.createElement("div");
        itemsWrap.style.marginTop = "10px";
        itemsWrap.style.display = "flex";
        itemsWrap.style.flexDirection = "column";
        itemsWrap.style.gap = "8px";

        (arch.items||[]).forEach(it=>{
          itemsWrap.appendChild(renderMovementRow(it, {
            onRefresh: renderArchive,
            onDelete: ()=>{
              arch.items = arch.items.filter(x => x.id !== it.id);
              saveState();
              renderArchive();
            }
          }));
        });

        aDet.appendChild(itemsWrap);
        inner.appendChild(aDet);
      });

      det.appendChild(inner);
      archiveGroupsList.appendChild(det);
    });

    // ====== ARCHIVOS SUELTOS (no agrupados) ======
    state.archives.forEach(arch=>{
      if(gSet.has(arch.id)) return; // si est√° en grupo, no se repite aqu√≠

      const det = document.createElement("details");
      det.className = "archive";

      const sum = document.createElement("summary");

      const left = document.createElement("div");
      left.className = "archiveTitle";

      // ‚úÖ casilla simple sin texto
      const chkWrap = document.createElement("label");
      chkWrap.className = "archiveChk";
      chkWrap.title = "Marcar para agrupar";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedArchiveIds.has(arch.id);
      cb.addEventListener("click", (e)=> e.stopPropagation());
      cb.addEventListener("change", ()=>{
        if(cb.checked) selectedArchiveIds.add(arch.id);
        else selectedArchiveIds.delete(arch.id);
      });
      chkWrap.appendChild(cb);

      const nameSpan = document.createElement("span");
      nameSpan.textContent = arch.name;

      const renameBtn = document.createElement("button");
      renameBtn.className = "iconBtn";
      renameBtn.textContent = "‚úèÔ∏è";
      renameBtn.title = "Renombrar";
      renameBtn.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        openTextModal({
          title:"Renombrar archivo",
          initialValue: arch.name,
          okText:"Guardar",
          onOk:(newName)=>{ arch.name = newName; saveState(); renderArchive(); }
        });
      });

      left.appendChild(chkWrap);
      left.appendChild(nameSpan);
      left.appendChild(renameBtn);

      const right = document.createElement("div");
      const delGroupBtn = document.createElement("button");
      delGroupBtn.className = "iconBtn danger";
      delGroupBtn.textContent = "üóëÔ∏è";
      delGroupBtn.title = "Borrar (a papelera)";
      delGroupBtn.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        openModal({
          title:"Borrar archivo",
          bodyNode:(()=>{const d=document.createElement("div"); d.textContent=`¬øSeguro que quieres borrar "${arch.name}"? Se enviar√° a la papelera.`; return d;})(),
          okText:"Borrar",
          cancelText:"Cancelar",
          onOk: ()=>{
            moveArchiveToTrash(arch);
            renderArchive();
            renderTrash();
            return true;
          }
        });
      });
      right.appendChild(delGroupBtn);

      sum.appendChild(left);
      sum.appendChild(right);
      det.appendChild(sum);

      const inner = document.createElement("div");
      inner.style.marginTop = "10px";
      inner.style.display = "flex";
      inner.style.flexDirection = "column";
      inner.style.gap = "8px";

      (arch.items || []).forEach(it=>{
        inner.appendChild(renderMovementRow(it, {
          onRefresh: renderArchive,
          onDelete: ()=>{
            arch.items = arch.items.filter(x => x.id !== it.id);
            saveState();
            renderArchive();
          }
        }));
      });

      det.appendChild(inner);
      archiveList.appendChild(det);
    });

    renderTrash();
  }

  btnExport.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "financium_backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  btnImport.addEventListener("click", ()=> importFile.click());
  importFile.addEventListener("change", async ()=>{
    const file = importFile.files && importFile.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const parsed = JSON.parse(text);
      openModal({
        title:"Importar",
        bodyNode:(()=>{const d=document.createElement("div"); d.textContent="Esto reemplaza tus datos. ¬øContinuar?"; return d;})(),
        okText:"Importar",
        cancelText:"Cancelar",
        onOk: ()=>{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
          location.reload();
          return true;
        }
      });
    }catch(e){}
    finally{ importFile.value = ""; }
  });

  /* =========================
     Forecast (igual que antes)
     ========================= */
  function ensureYearContainers(year){
    if(!state.forecast[year]) state.forecast[year] = {};
    if(!state.monthColors[year]) state.monthColors[year] = {};
  }
  function getForecastMonthItems(year, monthIndex){
    ensureYearContainers(year);
    if(!Array.isArray(state.forecast[year][monthIndex])) state.forecast[year][monthIndex] = [];
    return state.forecast[year][monthIndex];
  }
  function getMonthColor(year, monthIndex){
    ensureYearContainers(year);
    return state.monthColors[year][monthIndex] || "#ffffff";
  }
  function setMonthColor(year, monthIndex, color){
    ensureYearContainers(year);
    state.monthColors[year][monthIndex] = color;
    saveState();
  }

  function openColorPicker({ title, onPick }){
    const box = document.createElement("div");
    box.innerHTML = `<label>Elige un color</label>`;

    const colors = [
      {c:"#ffffff", t:"‚Äî"},
      {c:"#eaf2ff", t:"Azul"},
      {c:"#d1fae5", t:"Verde"},
      {c:"#fee2e2", t:"Rojo"},
      {c:"#fef3c7", t:"Amarillo"},
      {c:"#e9d5ff", t:"Lila"},
      {c:"#cffafe", t:"Turq"},
      {c:"#fce7f3", t:"Rosa"},
      {c:"#e5e7eb", t:"Gris"},
      {c:"#111827", t:"Negro"}
    ];

    const grid = document.createElement("div");
    grid.className = "colorGrid";

    colors.forEach(o=>{
      const sw = document.createElement("button");
      sw.type = "button";
      sw.className = "colorSwatch";
      sw.style.background = o.c;
      sw.style.color = (o.c === "#111827") ? "#fff" : "#0b2a5a";
      sw.textContent = o.t;
      sw.addEventListener("click", ()=>{
        onPick(o.c);
        closeModal();
      });
      grid.appendChild(sw);
    });

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = "Se guarda autom√°ticamente.";

    box.appendChild(grid);
    box.appendChild(hint);

    openModal({ title, bodyNode: box, okText:"", cancelText:"", onOk: ()=>true });
  }

  const yearLabel = document.getElementById("yearLabel");
  const yearBalanceEl = document.getElementById("yearBalance");
  const monthsGrid = document.getElementById("monthsGrid");

  function renderForecast(){
    const year = new Date().getFullYear();
    ensureYearContainers(year);
    yearLabel.textContent = year;

    let annual = 0;
    for(let m=0; m<12; m++){
      const items = getForecastMonthItems(year, m);
      annual += computeBalance(items).balance;
    }
    yearBalanceEl.textContent = fmtEUR(annual);

    monthsGrid.innerHTML = "";
    for(let m=0; m<12; m++){
      const items = getForecastMonthItems(year, m);
      const { balance } = computeBalance(items);

      const card = document.createElement("div");
      card.className = "month";
      card.style.background = getMonthColor(year, m);

      const tools = document.createElement("div");
      tools.className = "monthTools";
      const paint = document.createElement("button");
      paint.type = "button";
      paint.textContent = "üé®";
      paint.title = "Color del mes";
      paint.addEventListener("click", (e)=>{
        e.stopPropagation();
        openColorPicker({
          title: `Color: ${MONTHS_ES[m]}`,
          onPick: (c)=>{ setMonthColor(year, m, c); renderForecast(); }
        });
      });
      tools.appendChild(paint);
      card.appendChild(tools);

      const name = document.createElement("div");
      name.className = "monthName";
      name.textContent = MONTHS_ES[m];

      const bal = document.createElement("div");
      bal.className = "monthBal";
      bal.textContent = fmtEUR(balance);

      card.appendChild(name);
      card.appendChild(bal);

      card.addEventListener("click", ()=>{
        currentForecastMonth = { year, monthIndex: m };
        showPage("forecastMonth");
      });

      monthsGrid.appendChild(card);
    }
  }

  const monthTitle = document.getElementById("monthTitle");
  const btnBackForecast = document.getElementById("btnBackForecast");
  const btnMonthColor = document.getElementById("btnMonthColor");
  const fAmount = document.getElementById("fAmount");
  const fConcept = document.getElementById("fConcept");
  const fType = document.getElementById("fType");
  const btnAddForecast = document.getElementById("btnAddForecast");
  const btnClearForecastMonth = document.getElementById("btnClearForecastMonth");
  const forecastMonthList = document.getElementById("forecastMonthList");

  btnBackForecast.addEventListener("click", ()=> showPage("forecast"));

  btnMonthColor.addEventListener("click", ()=>{
    if(!currentForecastMonth) return;
    const { year, monthIndex } = currentForecastMonth;
    openColorPicker({
      title: `Color: ${MONTHS_ES[monthIndex]}`,
      onPick: (c)=>{ setMonthColor(year, monthIndex, c); renderForecast(); }
    });
  });

  btnAddForecast.addEventListener("click", ()=>{
    if(!currentForecastMonth) return;

    const amount = Number(String(fAmount.value).replace(",", "."));
    const concept = String(fConcept.value||"").trim();
    const type = fType.value;

    if(!Number.isFinite(amount) || amount === 0) return;
    if(!concept) return;

    const items = getForecastMonthItems(currentForecastMonth.year, currentForecastMonth.monthIndex);
    items.unshift(normalizeItem({ amount, concept, type, createdAt: nowISO() }));
    saveState();

    fAmount.value=""; fConcept.value=""; fType.value="income";
    renderForecastMonth();
    renderForecast();
  });

  btnClearForecastMonth.addEventListener("click", ()=>{
    if(!currentForecastMonth) return;
    const items = getForecastMonthItems(currentForecastMonth.year, currentForecastMonth.monthIndex);
    if(!items.length) return;

    openModal({
      title:"Limpiar",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øBorrar todos los movimientos del mes?"; return d;})(),
      okText:"Borrar",
      cancelText:"Cancelar",
      onOk: ()=>{
        state.forecast[currentForecastMonth.year][currentForecastMonth.monthIndex] = [];
        saveState();
        renderForecastMonth(); renderForecast();
        return true;
      }
    });
  });

  function renderForecastMonth(){
    if(!currentForecastMonth){ showPage("forecast"); return; }
    const { year, monthIndex } = currentForecastMonth;
    const items = getForecastMonthItems(year, monthIndex);
    monthTitle.textContent = `${MONTHS_ES[monthIndex]} ${year}`;

    forecastMonthList.innerHTML = "";
    items.forEach(it=>{
      forecastMonthList.appendChild(renderMovementRow(it, {
        onRefresh: ()=>{ saveState(); renderForecastMonth(); renderForecast(); },
        onDelete: ()=>{ state.forecast[year][monthIndex] = items.filter(x => x.id !== it.id); saveState(); renderForecastMonth(); renderForecast(); },
        showCoin:false
      }));
    });
  }

  /* =========================
     Deudas (igual que antes, con fecha al tick)
     ========================= */
  const dEntity = document.getElementById("dEntity");
  const dTotal = document.getElementById("dTotal");
  const dInstallment = document.getElementById("dInstallment");
  const dMonths = document.getElementById("dMonths");
  const dNote = document.getElementById("dNote");
  const btnAddDebt = document.getElementById("btnAddDebt");
  const btnClearDebts = document.getElementById("btnClearDebts");
  const debtsActiveList = document.getElementById("debtsActiveList");
  const debtsPaidList = document.getElementById("debtsPaidList");

  function allPaid(debt){ return debt.payments.every(Boolean); }
  function paidCount(debt){ return debt.payments.filter(Boolean).length; }

  function openEditDebtModal(debt, onSave){
    const wrap = document.createElement("div");
    wrap.className = "row";

    const f1 = document.createElement("div");
    f1.innerHTML = `<label>Persona / Entidad</label>`;
    const iEntity = document.createElement("input");
    iEntity.type = "text";
    iEntity.value = debt.entity || "";
    f1.appendChild(iEntity);

    const f2 = document.createElement("div");
    f2.innerHTML = `<label>Importe total</label>`;
    const iTotal = document.createElement("input");
    iTotal.type = "number"; iTotal.step = "0.01"; iTotal.inputMode = "decimal";
    iTotal.value = String(debt.total ?? 0);
    f2.appendChild(iTotal);

    const f4 = document.createElement("div");
    f4.innerHTML = `<label>Cuota</label>`;
    const iInst = document.createElement("input");
    iInst.type = "number"; iInst.step="0.01"; iInst.inputMode="decimal";
    iInst.value = String(debt.installmentAmount ?? 0);
    f4.appendChild(iInst);

    const f5 = document.createElement("div");
    f5.innerHTML = `<label>N¬∫ de cuotas</label>`;
    const iCount = document.createElement("input");
    iCount.type = "number"; iCount.step="1"; iCount.inputMode="numeric";
    iCount.value = String(debt.installmentsCount ?? 1);
    f5.appendChild(iCount);

    const f6 = document.createElement("div");
    f6.style.flex = "1 1 100%";
    f6.innerHTML = `<label>Nota</label>`;
    const iNote = document.createElement("textarea");
    iNote.value = debt.note || "";
    f6.appendChild(iNote);

    wrap.appendChild(f1); wrap.appendChild(f2); wrap.appendChild(f4); wrap.appendChild(f5); wrap.appendChild(f6);

    openModal({
      title: "Editar deuda",
      bodyNode: wrap,
      okText: "Guardar",
      cancelText: "Cancelar",
      onOk: ()=>{
        const entity = String(iEntity.value||"").trim();
        const total = Number(String(iTotal.value).replace(",", "."));
        const inst = Number(String(iInst.value).replace(",", "."));
        const cnt = Math.max(1, Math.floor(Number(iCount.value || 1)));
        const note = String(iNote.value||"");

        if(!entity){ iEntity.focus(); return false; }
        if(!Number.isFinite(total) || total < 0){ iTotal.focus(); return false; }
        if(!Number.isFinite(inst) || inst < 0){ iInst.focus(); return false; }

        debt.entity = entity;
        debt.total = total;
        debt.installmentAmount = inst;
        debt.note = note;

        const oldPayments = Array.isArray(debt.payments) ? debt.payments.slice() : [];
        const oldDates = Array.isArray(debt.paymentDates) ? debt.paymentDates.slice() : [];

        debt.installmentsCount = cnt;
        debt.payments = oldPayments.slice(0, cnt);
        debt.paymentDates = oldDates.slice(0, cnt);

        while(debt.payments.length < cnt) debt.payments.push(false);
        while(debt.paymentDates.length < cnt) debt.paymentDates.push("");

        saveState();
        onSave();
        return true;
      }
    });
  }

  function openPaymentDateModal(defaultDate, onOk){
    const box = document.createElement("div");
    box.innerHTML = `<label>Fecha de pago</label>`;
    const inp = document.createElement("input");
    inp.type = "date";
    inp.value = defaultDate || todayISODate();
    box.appendChild(inp);

    openModal({
      title: "Cuota pagada",
      bodyNode: box,
      okText: "Guardar fecha",
      cancelText: "Cancelar",
      onOk: ()=>{
        const d = String(inp.value||"").trim();
        if(!d){ inp.focus(); return false; }
        onOk(d);
        return true;
      }
    });
  }

  function renderDebtCardActive(debt){
    const card = document.createElement("div");
    card.className = "debtCard";

    const top = document.createElement("div");
    top.className = "debtTop";

    const left = document.createElement("div");
    left.style.flex = "1";
    const title = document.createElement("div");
    title.className = "debtTitle";
    title.textContent = debt.entity || "Deuda";
    const sub = document.createElement("div");
    sub.className = "debtSub";
    const pc = paidCount(debt);
    sub.textContent = `${pc}/${debt.installmentsCount} cuotas pagadas`;
    left.appendChild(title);
    left.appendChild(sub);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.alignItems = "center";

    const magic = document.createElement("button");
    magic.className = "iconBtn magic";
    magic.title = "Liberar (mover a pagadas)";
    magic.textContent = "ü™Ñ";
    const canLiberate = allPaid(debt);
    magic.disabled = !canLiberate;
    magic.style.opacity = canLiberate ? "1" : ".45";
    magic.style.cursor = canLiberate ? "pointer" : "not-allowed";
    magic.addEventListener("click", ()=>{
      if(!allPaid(debt)) return;
      state.debts.active = state.debts.active.filter(x => x.id !== debt.id);
      state.debts.paid.unshift(debt);
      saveState();
      renderDebts();
    });

    const edit = document.createElement("button");
    edit.className = "iconBtn";
    edit.title = "Editar";
    edit.textContent = "‚úèÔ∏è";
    edit.addEventListener("click", ()=> openEditDebtModal(debt, renderDebts));

    const del = document.createElement("button");
    del.className = "iconBtn danger";
    del.title = "Borrar";
    del.textContent = "üóëÔ∏è";
    del.addEventListener("click", ()=>{
      openModal({
        title:"Borrar deuda",
        bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øSeguro?"; return d;})(),
        okText:"Borrar",
        cancelText:"Cancelar",
        onOk: ()=>{
          state.debts.active = state.debts.active.filter(x => x.id !== debt.id);
          saveState();
          renderDebts();
          return true;
        }
      });
    });

    right.appendChild(magic);
    right.appendChild(edit);
    right.appendChild(del);

    top.appendChild(left);
    top.appendChild(right);

    const meta = document.createElement("div");
    meta.className = "debtMeta";
    meta.innerHTML = `
      <span>Total: ${fmtEUR(debt.total)}</span>
      <span>Cuota: ${fmtEUR(debt.installmentAmount)}</span>
    `;

    const checks = document.createElement("div");
    checks.className = "checks";

    for(let i=0; i<debt.installmentsCount; i++){
      const lab = document.createElement("label");
      lab.className = "chk " + (debt.payments[i] ? "paid" : "");

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!debt.payments[i];

      cb.addEventListener("change", ()=>{
        if(cb.checked){
          openPaymentDateModal(debt.paymentDates[i] || todayISODate(), (dateStr)=>{
            debt.payments[i] = true;
            debt.paymentDates[i] = dateStr;
            saveState();
            renderDebts();
          });
          cb.checked = !!debt.payments[i];
        }else{
          debt.payments[i] = false;
          debt.paymentDates[i] = "";
          saveState();
          renderDebts();
        }
      });

      const txt = document.createElement("span");
      txt.textContent = `#${i+1}`;

      lab.appendChild(cb);
      lab.appendChild(txt);

      const date = document.createElement("div");
      date.className = "dateTag";
      date.textContent = debt.paymentDates[i] ? debt.paymentDates[i] : "";
      lab.appendChild(date);

      checks.appendChild(lab);
    }

    card.appendChild(top);
    card.appendChild(meta);

    if(debt.note && String(debt.note).trim()){
      const note = document.createElement("div");
      note.style.color = "#111827";
      note.style.fontWeight = "800";
      note.style.fontSize = "12px";
      note.style.opacity = ".9";
      note.textContent = debt.note;
      card.appendChild(note);
    }

    card.appendChild(checks);
    return card;
  }

  function renderDebtCardPaidCompact(debt){
    const wrap = document.createElement("div");

    const compact = document.createElement("div");
    compact.className = "paidCompact";

    const left = document.createElement("div");
    left.className = "left";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = debt.entity || "Deuda pagada";

    const small = document.createElement("div");
    small.className = "small";
    small.innerHTML = `
      <span>Total: ${fmtEUR(debt.total)}</span>
      <span>Cuota: ${fmtEUR(debt.installmentAmount)}</span>
      <span>${paidCount(debt)}/${debt.installmentsCount}</span>
    `;

    left.appendChild(name);
    left.appendChild(small);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.alignItems = "center";

    const edit = document.createElement("button");
    edit.className = "iconBtn";
    edit.title = "Editar";
    edit.textContent = "‚úèÔ∏è";
    edit.addEventListener("click", ()=> openEditDebtModal(debt, renderDebts));

    const del = document.createElement("button");
    del.className = "iconBtn danger";
    del.title = "Borrar";
    del.textContent = "üóëÔ∏è";
    del.addEventListener("click", ()=>{
      openModal({
        title:"Borrar deuda pagada",
        bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øSeguro?"; return d;})(),
        okText:"Borrar",
        cancelText:"Cancelar",
        onOk: ()=>{
          state.debts.paid = state.debts.paid.filter(x => x.id !== debt.id);
          saveState();
          renderDebts();
          return true;
        }
      });
    });

    right.appendChild(edit);
    right.appendChild(del);

    compact.appendChild(left);
    compact.appendChild(right);

    const det = document.createElement("details");
    det.className = "archive";
    det.style.marginTop = "8px";
    det.open = false;

    const sum = document.createElement("summary");
    const sLeft = document.createElement("div");
    sLeft.className = "archiveTitle";
    const sp = document.createElement("span");
    sp.textContent = "Ver detalle";
    sLeft.appendChild(sp);
    sum.appendChild(sLeft);
    det.appendChild(sum);

    const body = document.createElement("div");
    body.style.marginTop = "10px";

    const checks = document.createElement("div");
    checks.className = "checks";
    for(let i=0; i<debt.installmentsCount; i++){
      const lab = document.createElement("div");
      lab.className = "chk " + (debt.payments[i] ? "paid" : "");
      lab.style.cursor = "default";
      lab.innerHTML = `<div style="font-weight:1000">#${i+1}</div><div class="dateTag">${debt.paymentDates[i] ? debt.paymentDates[i] : ""}</div>`;
      checks.appendChild(lab);
    }

    if(debt.note && String(debt.note).trim()){
      const note = document.createElement("div");
      note.style.marginBottom = "10px";
      note.style.color = "#111827";
      note.style.fontWeight = "800";
      note.style.fontSize = "12px";
      note.style.opacity = ".9";
      note.textContent = debt.note;
      body.appendChild(note);
    }

    body.appendChild(checks);
    det.appendChild(body);

    wrap.appendChild(compact);
    wrap.appendChild(det);
    return wrap;
  }

  btnAddDebt.addEventListener("click", ()=>{
    const entity = String(dEntity.value||"").trim();
    const total = Number(String(dTotal.value).replace(",", "."));
    const inst = Number(String(dInstallment.value).replace(",", "."));
    const cnt = Math.max(1, Math.floor(Number(dMonths.value || 1)));
    const note = String(dNote.value||"");

    if(!entity) return;
    if(!Number.isFinite(total) || total < 0) return;
    if(!Number.isFinite(inst) || inst < 0) return;

    state.debts.active.unshift(normalizeDebt({
      entity,
      total,
      installmentAmount: inst,
      installmentsCount: cnt,
      note,
      payments: Array(cnt).fill(false),
      paymentDates: Array(cnt).fill(""),
      createdAt: nowISO()
    }));
    saveState();

    dEntity.value = "";
    dTotal.value = "";
    dInstallment.value = "";
    dMonths.value = "";
    dNote.value = "";
    renderDebts();
  });

  btnClearDebts.addEventListener("click", ()=>{
    if(!state.debts.active.length && !state.debts.paid.length) return;
    openModal({
      title:"Limpiar deudas",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øBorrar TODAS las deudas (activas y pagadas)?"; return d;})(),
      okText:"Borrar",
      cancelText:"Cancelar",
      onOk: ()=>{
        state.debts.active = [];
        state.debts.paid = [];
        saveState();
        renderDebts();
        return true;
      }
    });
  });

  function renderDebts(){
    debtsActiveList.innerHTML = "";
    debtsPaidList.innerHTML = "";

    state.debts.active.forEach(d=>{
      debtsActiveList.appendChild(renderDebtCardActive(d));
    });

    state.debts.paid.forEach(d=>{
      debtsPaidList.appendChild(renderDebtCardPaidCompact(d));
    });
  }

  /* =========================
     Init
     ========================= */
  showPage("home");
  renderPresent();
  renderSavings();
  renderArchive();
  renderForecast();
  renderDebts();
</script>
</body>
</html>
