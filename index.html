<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Financium Ultimate</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#134a9e">
  <meta name="description" content="Financium Ultimate: Presente, Archivo, Previsi√≥n, Ahorro y Deudas.">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Financium">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    :root{
      --blue-900:#0b2a5a;
      --blue-700:#134a9e;
      --blue-100:#eaf2ff;
      --shadow: 0 10px 25px rgba(0,0,0,.12);
      --muted:#6b7280;
      --border:#dbe6ff;
      --card:#ffffff;
      --yellow:#ffd23f;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, var(--blue-100), #f7fbff 55%, #ffffff);
      color:#0f172a;
    }

    header{
      position: sticky;
      top:0;
      z-index: 50;
      background: linear-gradient(90deg, var(--blue-900), var(--blue-700));
      box-shadow: var(--shadow);
    }
    .header-inner{
      width: 100%;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .brand{ flex: 1 1 520px; min-width: 0; }
    .brand img{
      width: 100%;
      height: 70px;
      object-fit: cover;
      border-radius: 12px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    main{ max-width:1100px; margin: 0 auto; padding: 16px 14px 40px; }

    .btn{
      border:0;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      background: rgba(255,255,255,.14);
      color: #fff;
      transition: transform .05s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.22); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background: rgba(255,255,255,.10); }
    .btn.primary{ background: #ffffff; color: var(--blue-900); }

    .backArrow{
      border: 0;
      cursor: pointer;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 1000;
      background: var(--yellow);
      color: #1b2a4a;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      font-size: 18px;
      line-height: 1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .backArrow:hover{ filter: brightness(1.03); }
    .backArrow:active{ transform: translateY(1px); }

    /* ===== HOME GRID ===== */
    .home-grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 14px;
      margin-top: 10px;
    }
    @media (max-width: 1100px){ .home-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width: 720px){ .home-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 520px){ .home-grid{ grid-template-columns: 1fr; } }

    .tile{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 20px rgba(19,74,158,.10);
      padding: 16px;
      display:flex;
      gap: 14px;
      align-items:center;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .15s ease;
    }
    .tile:hover{ transform: translateY(-1px); box-shadow: 0 16px 28px rgba(19,74,158,.14); }

    .tile img{
      width:112px; height:112px;
      object-fit: contain;
      border-radius: 22px;
      background: var(--blue-100);
      padding: 12px;
    }
    .tile strong{ font-size: 20px; color: var(--blue-900); font-weight: 1000; }

    /* ‚úÖ FIX: en laptop, tiles compactos y centrados (sin romper m√≥vil) */
    @media (min-width: 900px) {
      main{ max-width: 1200px; }
      .home-grid{
        grid-template-columns: repeat(5, minmax(180px, 1fr));
        gap: 16px;
        align-items: stretch;
      }
      .tile{
        flex-direction: column;
        justify-content: center;
        text-align: center;
        padding: 18px 14px;
        gap: 12px;
        min-height: 190px;
      }
      .tile img{
        width: 110px;
        height: 110px;
        margin: 0 auto;
      }
      .tile strong{
        font-size: 18px;
        line-height: 1.1;
      }
    }
    @media (min-width: 1300px){
      main{ max-width: 1280px; }
    }

    .page{ display:none; }
    .page.active{ display:block; }

    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 26px rgba(11,42,90,.08);
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row > * { flex: 1; min-width: 150px; }
    label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 800; }
    input, select, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid #cfe0ff;
      outline: none;
      background:#fff;
      font-size: 14px;
    }
    textarea{ resize: vertical; min-height: 44px; }
    input:focus, select:focus, textarea:focus{ border-color: #7aa8ff; box-shadow: 0 0 0 4px rgba(122,168,255,.18); }

    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top: 12px; flex-wrap:wrap; }
    .actions .btn{
      background: linear-gradient(90deg, var(--blue-900), var(--blue-700));
      color:#fff;
      padding: 10px 14px;
      border-radius: 12px;
    }
    .actions .btn.light{ background: #ffffff; color: var(--blue-900); border: 1px solid var(--border); }

    .list{ margin-top: 12px; display:flex; flex-direction:column; gap:8px; }

    .item{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      background:#fff;
    }

    .pill{
      font-size: 12px;
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .pill.income{ background: rgba(23,198,193,.20); color: #0b5b58; border: 1px solid rgba(23,198,193,.35); }
    .pill.expense{ background: rgba(255,111,97,.20); color: #7a1f17; border: 1px solid rgba(255,111,97,.35); }

    .item .meta{ flex:1; min-width:0; }
    .concept{ font-weight: 900; color: #0b2a5a; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    .amount{ font-weight: 1000; font-variant-numeric: tabular-nums; white-space:nowrap; }

    .iconBtn{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 1000;
      line-height: 1;
      user-select:none;
    }
    .iconBtn:hover{ background: var(--blue-100); }
    .iconBtn.danger:hover{ background: rgba(231,76,60,.12); border-color: rgba(231,76,60,.25); }
    .iconBtn.coin:hover{ background: rgba(46,204,113,.14); border-color: rgba(46,204,113,.25); }

    details.archive{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      background:#fff;
    }
    details.archive summary{
      cursor:pointer;
      font-weight: 1000;
      color: var(--blue-900);
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details.archive summary::-webkit-details-marker{ display:none; }
    .archiveTitle{ display:flex; align-items:center; gap:10px; min-width:0; flex:1; }
    .archiveTitle span{ overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }

    .spacer{ height: 10px; }

    .summaryBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 10px 18px rgba(11,42,90,.06);
    }
    .summaryBar .title{
      font-weight:1000;
      color: var(--blue-900);
      font-size: 14px;
    }
    .summaryBar .value{
      font-weight:1000;
      font-variant-numeric: tabular-nums;
      color: #0f172a;
      font-size: 14px;
    }

    .archiveChk{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#fff;
      user-select:none;
    }
    .archiveChk input{ width:auto; margin:0; }

    .puzzleBtn{
      border: 1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 1000;
      font-size: 18px;
      line-height: 1;
      user-select:none;
    }
    .puzzleBtn:hover{ background: var(--blue-100); }
    .puzzleBtn:active{ transform: translateY(1px); }

    .trashRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border: 1px dashed rgba(11,42,90,.25);
      border-radius: 16px;
      padding: 10px 12px;
      background:#fff;
    }
    .trashRow .name{
      font-weight:1000;
      color: var(--blue-900);
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .trashRow .meta{
      font-size: 12px;
      font-weight: 900;
      color: #111827;
      opacity: .85;
      white-space:nowrap;
    }

    .forecast-header{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom: 12px; flex-wrap:wrap; }
    .yearBox{ display:flex; flex-direction:column; gap:6px; }
    .yearTitle{ font-weight:1000; color:var(--blue-900); font-size:16px; }
    .yearBalance{ font-weight:1000; color:var(--blue-900); font-size:14px; }
    .months{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; }
    @media (max-width: 900px){ .months{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .month{
      border-radius: 16px; padding: 14px 12px; border: 1px solid var(--border); cursor:pointer;
      box-shadow: 0 10px 18px rgba(11,42,90,.06);
      transition: transform .08s ease, filter .12s ease;
      display:flex; flex-direction:column; gap:8px; justify-content:center; min-height: 104px;
      user-select:none; position:relative; overflow:hidden; background:#fff;
    }
    .month:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .monthName{ font-weight: 1000; color: var(--blue-900); text-align:center; font-size: 15px; }
    .monthBal{ text-align:center; font-weight: 1000; font-variant-numeric: tabular-nums; color:#0f172a; font-size: 14px; }
    .monthTools{ position:absolute; left:10px; top:8px; display:flex; gap:8px; opacity:.98; }
    .monthTools button{ border:1px solid rgba(0,0,0,.10); background: rgba(255,255,255,.80); border-radius: 10px; padding: 6px 8px; cursor:pointer; font-weight: 900; }
    .monthTools button:active{ transform: translateY(1px); }

    /* ===== DEUDAS ===== */
    .sectionCard{
      border: 1px solid var(--border);
      border-radius: 18px;
      background: #fff;
      padding: 12px;
      box-shadow: 0 10px 18px rgba(11,42,90,.06);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    .sectionCard:hover{ background: #f7fbff; }
    .sectionCard .left{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .sectionCard .t{ font-weight:1000; color: var(--blue-900); }
    .sectionCard .s{ font-weight:900; color:#111827; opacity:.8; font-size:12px; }

    .debtCompact{
      border: 1px solid var(--border);
      border-radius: 16px;
      background:#fff;
      padding: 10px 12px;
    }
    .debtCompact summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:1000;
      color: var(--blue-900);
    }
    .debtCompact summary::-webkit-details-marker{ display:none; }
    .debtRowLeft{ min-width:0; flex:1; display:flex; flex-direction:column; gap:4px; }
    .debtName{ overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    .debtLine{
      font-size:12px;
      font-weight:900;
      color:#111827;
      opacity:.85;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tag{
      border:1px solid var(--border);
      background:#f3f7ff;
      border-radius:999px;
      padding: 4px 8px;
      white-space:nowrap;
    }

    .payLog{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .payEntry{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 8px 10px;
      background:#fff;
    }
    .payEntry .l{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      font-weight:900; font-size:12px; color:#111827; opacity:.9;
    }
    .payEntry .r{ display:flex; gap:8px; align-items:center; }

    .paidCompact{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border: 1px solid var(--border);
      border-radius: 16px; padding: 12px; background: #fff;
    }
    .paidCompact .left{ min-width: 0; flex: 1; display:flex; flex-direction:column; gap:4px; }
    .paidCompact .name{ font-weight: 1000; color: var(--blue-900); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .paidCompact .small{ font-weight: 900; font-size: 12px; color: #111827; opacity: .9; display:flex; gap:8px; flex-wrap:wrap; }
    .paidCompact .small span{ background:#f3f7ff; border:1px solid var(--border); border-radius:999px; padding: 4px 8px; }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 100;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width: min(650px, 100%);
      background:#fff;
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .modalHeader h2{ margin: 0; font-size: 16px; color: var(--blue-900); font-weight: 1000; }
    .modalBody{ margin-top: 8px; }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }
    .modalActions .btn{
      background: linear-gradient(90deg, var(--blue-900), var(--blue-700));
      color:#fff;
    }
    .modalActions .btn.light{
      background:#fff;
      color: var(--blue-900);
      border: 1px solid var(--border);
    }

    .colorGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap:10px;
      margin-top:8px;
    }
    .colorSwatch{
      height:38px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      user-select:none;
      padding:0;
    }
    .hint{ font-size:12px; color: var(--muted); margin-top:6px; }
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="brand">
      <img src="./cabecera.png" alt="Financium" onerror="this.style.display='none'">
    </div>

    <div class="top-actions">
      <button id="btnShareBackup" class="btn secondary" title="Compartir o descargar tu backup">üì§ Backup</button>
      <button id="btnImportBackup" class="btn secondary" title="Importar un backup">üì• Importar</button>
      <input id="fileImportBackup" type="file" accept="application/json" style="display:none">

      <button id="btnBackHome" class="backArrow" style="display:none" title="Volver">‚¨ÖÔ∏è</button>
      <button id="btnArchivarTop" class="btn primary" style="display:none">üì¶ Archivar</button>
    </div>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="pageHome" class="page active">
    <div class="home-grid">
      <div class="tile" data-nav="present">
        <img src="./presente.png" alt="Presente" onerror="this.style.display='none'">
        <strong>Presente</strong>
      </div>

      <div class="tile" data-nav="archive">
        <img src="./archivo.png" alt="Archivo" onerror="this.style.display='none'">
        <strong>Archivo</strong>
      </div>

      <div class="tile" data-nav="forecast">
        <img src="./prevision.png" alt="Previsi√≥n" onerror="this.style.display='none'">
        <strong>Previsi√≥n</strong>
      </div>

      <div class="tile" data-nav="savings">
        <img src="./ahorro.png" alt="Ahorro" onerror="this.style.display='none'">
        <strong>Ahorro</strong>
      </div>

      <div class="tile" data-nav="debts">
        <img src="./deudas.png" alt="Deudas" onerror="this.style.display='none'">
        <strong>Deudas</strong>
      </div>
    </div>
  </section>

  <!-- PRESENT -->
  <section id="pagePresent" class="page">
    <div class="panel">

      <!-- Balance arriba -->
      <div class="summaryBar" style="margin-bottom:12px;">
        <div class="title">Balance</div>
        <div class="value" id="presentBalance">0,00 ‚Ç¨</div>
      </div>

      <div class="row">
        <div>
          <label for="pAmount">Cantidad</label>
          <input id="pAmount" type="number" step="0.01" inputmode="decimal" placeholder="0,00" />
        </div>
        <div>
          <label for="pConcept">Concepto</label>
          <input id="pConcept" type="text" />
        </div>
        <div>
          <label for="pType">Tipo</label>
          <select id="pType">
            <option value="income">Ingreso</option>
            <option value="expense">Gasto</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="btnAddPresent" class="btn">‚ûï A√±adir</button>
        <button id="btnClearPresent" class="btn light">üßπ Limpiar</button>
      </div>

      <div class="list" id="presentList"></div>
    </div>
  </section>

  <!-- AHORRO -->
  <section id="pageSavings" class="page">
    <div class="panel">
      <div class="summaryBar">
        <div class="title">Total acumulado</div>
        <div class="value" id="savingsTotal">0,00 ‚Ç¨</div>
      </div>

      <div class="list" id="savingsList"></div>
      <div class="spacer"></div>
      <div class="actions">
        <button id="btnClearSavings" class="btn light">üßπ Limpiar</button>
      </div>
    </div>
  </section>

  <!-- ARCHIVE -->
  <section id="pageArchive" class="page">
    <div class="panel">
      <div class="summaryBar" style="margin-bottom:12px;">
        <div class="title">Archivo</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;">
          <button id="btnGroupPuzzle" class="puzzleBtn" title="Agrupar seleccionados">üß©</button>
        </div>
      </div>

      <div class="list" id="archiveGroupsList"></div>
      <div class="spacer"></div>
      <div class="list" id="archiveList"></div>

      <div class="spacer"></div>

      <details class="archive">
        <summary>
          <div class="archiveTitle"><span>Papelera</span></div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button id="btnTrashWipeAll" class="iconBtn" title="Borrar definitivamente todo">üßΩ</button>
          </div>
        </summary>
        <div class="list" id="trashList" style="margin-top:10px;"></div>
      </details>

      <div class="spacer"></div>

      <div class="actions">
        <button id="btnExport" class="btn light">‚¨áÔ∏è Exportar</button>
        <button id="btnImport" class="btn light">‚¨ÜÔ∏è Importar</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none">
    </div>
  </section>

  <!-- FORECAST -->
  <section id="pageForecast" class="page">
    <div class="panel">
      <div class="forecast-header">
        <div class="yearBox">
          <div class="yearTitle"><span id="yearLabel"></span></div>
          <div class="yearBalance">Balance anual: <span id="yearBalance"></span></div>
        </div>
      </div>
      <div class="months" id="monthsGrid"></div>
    </div>
  </section>

  <!-- FORECAST MONTH DETAIL -->
  <section id="pageForecastMonth" class="page">
    <div class="panel">
      <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:1000;color:var(--blue-900);font-size:16px" id="monthTitle"></div>
        <div style="display:flex;gap:10px;align-items:center;">
          <button id="btnMonthColor" class="btn" style="background:#fff;color:var(--blue-900);border:1px solid var(--border);">üé® Color</button>
          <button id="btnBackForecast" class="btn" style="background:#fff;color:var(--blue-900);border:1px solid var(--border);">‚¨ÖÔ∏è</button>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="row">
        <div>
          <label for="fAmount">Cantidad</label>
          <input id="fAmount" type="number" step="0.01" inputmode="decimal" placeholder="0,00" />
        </div>
        <div>
          <label for="fConcept">Concepto</label>
          <input id="fConcept" type="text" />
        </div>
        <div>
          <label for="fType">Tipo</label>
          <select id="fType">
            <option value="income">Ingreso</option>
            <option value="expense">Gasto</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="btnAddForecast" class="btn">‚ûï A√±adir</button>
        <button id="btnClearForecastMonth" class="btn light">üßπ Limpiar</button>
      </div>

      <div class="list" id="forecastMonthList"></div>
    </div>
  </section>

  <!-- DEUDAS -->
  <section id="pageDebts" class="page">
    <div class="panel">

      <!-- HUB -->
      <div id="debtsHub">
        <div class="list" style="margin-top:0;">
          <div class="sectionCard" id="goNewDebt">
            <div class="left">
              <div class="t">Nueva deuda</div>
              <div class="s">Crear una deuda (total, entidad y nota)</div>
            </div>
            <div>‚ûï</div>
          </div>

          <div class="sectionCard" id="goActiveDebts">
            <div class="left">
              <div class="t">Deudas activas</div>
              <div class="s" id="activeCount">0</div>
            </div>
            <div>üìå</div>
          </div>

          <div class="sectionCard" id="goPaidDebts">
            <div class="left">
              <div class="t">Deudas ya pagadas</div>
              <div class="s" id="paidCount">0</div>
            </div>
            <div>‚úÖ</div>
          </div>
        </div>
      </div>

      <!-- NUEVA DEUDA -->
      <div id="debtsNew" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:1000;color:var(--blue-900);">Nueva deuda</div>
          <button class="iconBtn" id="backDebtsFromNew" title="Volver">‚¨ÖÔ∏è</button>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <div>
            <label for="dEntity">Persona / Entidad</label>
            <input id="dEntity" type="text" placeholder="Ej: Banco, Mar√≠a, etc." />
          </div>
          <div>
            <label for="dTotal">Importe total</label>
            <input id="dTotal" type="number" step="0.01" inputmode="decimal" placeholder="0,00" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div style="flex: 1 1 100%;">
            <label for="dNote">Nota / Asunto</label>
            <textarea id="dNote" placeholder="Ej: pr√©stamo coche, acuerdo, etc."></textarea>
          </div>
        </div>

        <div class="actions">
          <button id="btnAddDebt" class="btn">‚ûï Guardar deuda</button>
        </div>
      </div>

      <!-- DEUDAS ACTIVAS -->
      <div id="debtsActive" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:1000;color:var(--blue-900);">Deudas activas</div>
          <button class="iconBtn" id="backDebtsFromActive" title="Volver">‚¨ÖÔ∏è</button>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <div style="flex:2;min-width:220px;">
            <label for="debtSearch">Buscar</label>
            <input id="debtSearch" type="text" placeholder="Escribe el nombre..." />
          </div>
          <div style="flex:1;min-width:200px;">
            <label for="debtSort">Orden</label>
            <select id="debtSort">
              <option value="manual">Manual</option>
              <option value="az">Alfab√©tico A‚ÜíZ</option>
              <option value="total_desc">Mayor total</option>
              <option value="total_asc">Menor total</option>
            </select>
          </div>
        </div>

        <div class="list" id="debtsActiveList"></div>
      </div>

      <!-- DEUDAS PAGADAS -->
      <div id="debtsPaid" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:1000;color:var(--blue-900);">Deudas ya pagadas</div>
          <button class="iconBtn" id="backDebtsFromPaid" title="Volver">‚¨ÖÔ∏è</button>
        </div>

        <div class="spacer"></div>

        <div class="list" id="debtsPaidList"></div>
      </div>

    </div>
  </section>
</main>

<!-- MODAL -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <div class="modalHeader">
      <h2 id="modalTitle"></h2>
      <button id="btnModalCloseX" class="iconBtn" aria-label="Cerrar">‚úï</button>
    </div>
    <div id="modalBody" class="modalBody"></div>
    <div class="modalActions">
      <button id="btnModalCancel" class="btn light">Cancelar</button>
      <button id="btnModalOk" class="btn">Guardar</button>
    </div>
  </div>
</div>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }

  const fmtEUR = (n) => new Intl.NumberFormat('es-ES', { style:'currency', currency:'EUR' }).format(Number(n||0));
  const nowISO = () => new Date().toISOString();
  const todayISODate = () => new Date().toISOString().slice(0,10);
  const uid = () => Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  const MONTHS_ES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  const STORAGE_KEY = "financium_state_v10";

  function normalizeItem(it){
    return {
      id: it.id || uid(),
      amount: Number(it.amount || 0),
      concept: String(it.concept || ""),
      type: (it.type === "expense" ? "expense" : "income"),
      createdAt: it.createdAt || nowISO()
    };
  }

  function normalizeDebtNew(d){
    const total = Number(d.total || 0);
    const remaining =
      Number.isFinite(Number(d.remaining)) ? Number(d.remaining) :
      (Number.isFinite(total) ? total : 0);

    const payments = Array.isArray(d.payments)
      ? d.payments.map(p => ({
          id: p.id || uid(),
          date: p.date ? String(p.date) : "",
          amount: Number(p.amount || 0),
          createdAt: p.createdAt || nowISO()
        }))
      : [];

    return {
      id: d.id || uid(),
      entity: String(d.entity || ""),
      total: total,
      remaining: remaining,
      note: String(d.note || ""),
      payments,
      createdAt: d.createdAt || nowISO(),
      order: Number.isFinite(Number(d.order)) ? Number(d.order) : Date.now()
    };
  }

  function migrateOldDebtIfNeeded(d){
    if(d && (d.remaining !== undefined)) return normalizeDebtNew(d);

    const total = Number(d.total || 0);
    let paid = 0;

    if(Array.isArray(d.payments) && Array.isArray(d.paymentDates)){
      const inst = Number(d.installmentAmount || 0);
      d.payments.forEach((isPaid)=>{
        if(isPaid){ paid += inst; }
      });
    }

    const remaining = Math.max(0, total - paid);

    return normalizeDebtNew({
      id: d.id,
      entity: d.entity,
      total,
      remaining,
      note: d.note || "",
      payments: [],
      createdAt: d.createdAt,
      order: d.order
    });
  }

  function normalizeArchive(a){
    return {
      id: a.id || uid(),
      name: String(a.name || "Archivo"),
      createdAt: a.createdAt || nowISO(),
      items: (a.items || []).map(normalizeItem)
    };
  }

  function normalizeGroup(g){
    const ids = Array.isArray(g.archiveIds) ? g.archiveIds.map(String) : [];
    return {
      id: g.id || uid(),
      name: String(g.name || "Grupo"),
      archiveIds: Array.from(new Set(ids)),
      createdAt: g.createdAt || nowISO()
    };
  }

  function normalizeTrash(t){
    const a = normalizeArchive(t);
    return { ...a, deletedAt: t.deletedAt || nowISO() };
  }

  function emptyState(){
    const year = new Date().getFullYear();
    return {
      present: [],
      savings: [],
      archives: [],
      archiveGroups: [],
      trashArchives: [],
      forecast: { [year]: {} },
      monthColors: { [year]: {} },
      debts: { active: [], paid: [] }
    };
  }

  function loadState(){
    const year = new Date().getFullYear();
    const base = emptyState();
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return base;
      const s = JSON.parse(raw);

      if(!Array.isArray(s.present)) s.present = [];
      if(!Array.isArray(s.savings)) s.savings = [];
      if(!Array.isArray(s.archives)) s.archives = [];
      if(!Array.isArray(s.archiveGroups)) s.archiveGroups = [];
      if(!Array.isArray(s.trashArchives)) s.trashArchives = [];

      if(!s.forecast || typeof s.forecast !== "object") s.forecast = base.forecast;
      if(!s.monthColors || typeof s.monthColors !== "object") s.monthColors = base.monthColors;
      if(!s.debts || typeof s.debts !== "object") s.debts = base.debts;
      if(!Array.isArray(s.debts.active)) s.debts.active = [];
      if(!Array.isArray(s.debts.paid)) s.debts.paid = [];

      if(!s.forecast[year]) s.forecast[year] = {};
      if(!s.monthColors[year]) s.monthColors[year] = {};

      s.present = s.present.map(normalizeItem);
      s.savings = s.savings.map(normalizeItem);
      s.archives = s.archives.map(normalizeArchive);
      s.archiveGroups = s.archiveGroups.map(normalizeGroup);
      s.trashArchives = s.trashArchives.map(normalizeTrash);

      for(const y of Object.keys(s.forecast)){
        const obj = s.forecast[y] || {};
        for(const m of Object.keys(obj)){
          obj[m] = (obj[m] || []).map(normalizeItem);
        }
        s.forecast[y] = obj;
      }

      s.debts.active = s.debts.active.map(migrateOldDebtIfNeeded);
      s.debts.paid = s.debts.paid.map(migrateOldDebtIfNeeded);

      const archiveIdSet = new Set(s.archives.map(a => a.id));
      s.archiveGroups.forEach(g=>{
        g.archiveIds = g.archiveIds.filter(id => archiveIdSet.has(id));
      });
      s.archiveGroups = s.archiveGroups.filter(g => g.archiveIds.length > 0);

      return s;
    }catch(e){
      return base;
    }
  }

  let state = loadState();
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  /* Backup manual */
  const btnShareBackup = document.getElementById("btnShareBackup");
  const btnImportBackup = document.getElementById("btnImportBackup");
  const fileImportBackup = document.getElementById("fileImportBackup");

  btnShareBackup.addEventListener("click", async ()=>{
    const raw = localStorage.getItem(STORAGE_KEY);
    const data = raw ? raw : JSON.stringify(emptyState());
    const blob = new Blob([data], { type:"application/json" });
    const file = new File([blob], "financium_backup.json", { type:"application/json" });

    if(navigator.share && navigator.canShare && navigator.canShare({ files:[file] })){
      try{
        await navigator.share({ files:[file], title:"Financium backup", text:"Backup de Financium" });
        return;
      }catch(e){}
    }

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "financium_backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  btnImportBackup.addEventListener("click", ()=> fileImportBackup.click());

  fileImportBackup.addEventListener("change", async ()=>{
    const file = fileImportBackup.files && fileImportBackup.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      JSON.parse(text);
      localStorage.setItem(STORAGE_KEY, text);
      alert("Backup importado. Se recargar√° la app.");
      location.reload();
    }catch(e){
      alert("Archivo inv√°lido.");
    }finally{
      fileImportBackup.value = "";
    }
  });

  /* Modal gen√©rico */
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const btnModalOk = document.getElementById("btnModalOk");
  const btnModalCancel = document.getElementById("btnModalCancel");
  const btnModalCloseX = document.getElementById("btnModalCloseX");
  let modalOnOk = null;

  function closeModal(){
    modalBackdrop.classList.remove("show");
    modalTitle.textContent = "";
    modalBody.innerHTML = "";
    modalOnOk = null;
  }
  function openModal({ title, bodyNode, okText="Guardar", cancelText="Cancelar", onOk }){
    modalTitle.textContent = title;
    modalBody.innerHTML = "";
    modalBody.appendChild(bodyNode);
    btnModalOk.textContent = okText;

    if(String(cancelText||"") === ""){
      btnModalCancel.style.display = "none";
    }else{
      btnModalCancel.style.display = "inline-flex";
      btnModalCancel.textContent = cancelText;
    }

    modalOnOk = onOk;
    modalBackdrop.classList.add("show");

    setTimeout(()=>{
      const f = modalBody.querySelector("input, textarea, select, button");
      if(f && f.focus) f.focus();
      if(f && f.select) f.select();
    }, 0);
  }
  btnModalCancel.addEventListener("click", closeModal);
  btnModalCloseX.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e)=>{ if(e.target === modalBackdrop) closeModal(); });
  btnModalOk.addEventListener("click", async ()=>{
    if(typeof modalOnOk === "function"){
      const ok = await modalOnOk();
      if(ok !== false) closeModal();
    }else closeModal();
  });

  function openTextModal({ title, initialValue, okText, onOk }){
    const box = document.createElement("div");
    box.innerHTML = `<label>Nombre</label>`;
    const inp = document.createElement("input");
    inp.type = "text";
    inp.value = initialValue || "";
    box.appendChild(inp);

    openModal({
      title, bodyNode: box,
      okText, cancelText: "Cancelar",
      onOk: ()=>{
        const v = String(inp.value||"").trim();
        if(!v){ inp.focus(); return false; }
        onOk(v);
        return true;
      }
    });
  }

  function computeBalance(items){
    let income = 0, expense = 0;
    for(const it of items){
      const v = Number(it.amount || 0);
      if(it.type === "income") income += v;
      else expense += v;
    }
    return { income, expense, balance: income - expense };
  }

  /* Navegaci√≥n */
  const pages = {
    home: document.getElementById("pageHome"),
    present: document.getElementById("pagePresent"),
    savings: document.getElementById("pageSavings"),
    archive: document.getElementById("pageArchive"),
    forecast: document.getElementById("pageForecast"),
    forecastMonth: document.getElementById("pageForecastMonth"),
    debts: document.getElementById("pageDebts"),
  };

  const btnBackHome = document.getElementById("btnBackHome");
  const btnArchivarTop = document.getElementById("btnArchivarTop");
  let currentForecastMonth = null;

  function setTopButtons(view){
    btnBackHome.style.display = (view === "home") ? "none" : "inline-flex";
    btnArchivarTop.style.display = (view === "present") ? "inline-flex" : "none";
  }
  function showPage(view){
    Object.values(pages).forEach(p => p.classList.remove("active"));
    pages[view].classList.add("active");
    setTopButtons(view);

    if(view === "present") renderPresent();
    if(view === "savings") renderSavings();
    if(view === "archive") renderArchive();
    if(view === "forecast") renderForecast();
    if(view === "forecastMonth") renderForecastMonth();
    if(view === "debts") renderDebtsHub();
  }

  document.querySelectorAll(".tile").forEach(tile=>{
    tile.addEventListener("click", ()=>{
      const nav = tile.dataset.nav;
      if(nav) showPage(nav);
    });
  });
  btnBackHome.addEventListener("click", ()=> showPage("home"));

  /* Movimientos */
  function openEditMovementModal(item, onSave){
    const wrap = document.createElement("div");
    wrap.className = "row";

    const a = document.createElement("div");
    a.innerHTML = `<label>Cantidad</label>`;
    const inpAmount = document.createElement("input");
    inpAmount.type = "number";
    inpAmount.step = "0.01";
    inpAmount.inputMode = "decimal";
    inpAmount.value = String(item.amount ?? 0);
    a.appendChild(inpAmount);

    const b = document.createElement("div");
    b.innerHTML = `<label>Concepto</label>`;
    const inpConcept = document.createElement("input");
    inpConcept.type = "text";
    inpConcept.value = item.concept || "";
    b.appendChild(inpConcept);

    const c = document.createElement("div");
    c.innerHTML = `<label>Tipo</label>`;
    const selType = document.createElement("select");
    selType.innerHTML = `<option value="income">Ingreso</option><option value="expense">Gasto</option>`;
    selType.value = item.type || "income";
    c.appendChild(selType);

    wrap.appendChild(a); wrap.appendChild(b); wrap.appendChild(c);

    openModal({
      title: "Editar movimiento",
      bodyNode: wrap,
      okText: "Guardar",
      cancelText: "Cancelar",
      onOk: ()=>{
        const n = Number(String(inpAmount.value).replace(",", "."));
        const concept = String(inpConcept.value||"").trim();
        if(!Number.isFinite(n)){ inpAmount.focus(); return false; }
        if(!concept){ inpConcept.focus(); return false; }
        item.amount = n;
        item.concept = concept;
        item.type = selType.value;
        saveState();
        onSave();
        return true;
      }
    });
  }

  function renderMovementRow(item, { onRefresh, onDelete, showCoin=false, onCoin=null }){
    const row = document.createElement("div");
    row.className = "item";

    const pill = document.createElement("div");
    pill.className = "pill " + (item.type === "expense" ? "expense" : "income");
    pill.textContent = item.type === "expense" ? "Gasto" : "Ingreso";

    const meta = document.createElement("div");
    meta.className = "meta";
    const concept = document.createElement("div");
    concept.className = "concept";
    concept.textContent = item.concept || "";
    meta.appendChild(concept);

    const amount = document.createElement("div");
    amount.className = "amount";
    amount.textContent = fmtEUR(item.amount);

    row.appendChild(pill);
    row.appendChild(meta);
    row.appendChild(amount);

    if(showCoin){
      const coin = document.createElement("button");
      coin.className = "iconBtn coin";
      coin.title = "Pasar a Ahorro";
      coin.textContent = "ü™ô";
      coin.addEventListener("click", ()=> onCoin && onCoin());
      row.appendChild(coin);
    }

    const edit = document.createElement("button");
    edit.className = "iconBtn";
    edit.title = "Editar";
    edit.textContent = "‚úèÔ∏è";
    edit.addEventListener("click", ()=> openEditMovementModal(item, onRefresh));

    const del = document.createElement("button");
    del.className = "iconBtn danger";
    del.title = "Borrar";
    del.textContent = "üóëÔ∏è";
    del.addEventListener("click", ()=>{
      openModal({
        title:"Borrar movimiento",
        bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øSeguro?"; return d;})(),
        okText:"Borrar",
        cancelText:"Cancelar",
        onOk: ()=>{ onDelete(); return true; }
      });
    });

    row.appendChild(edit);
    row.appendChild(del);
    return row;
  }

  /* =========================
     Presente
     ========================= */
  const presentBalanceEl = document.getElementById("presentBalance");
  const pAmount = document.getElementById("pAmount");
  const pConcept = document.getElementById("pConcept");
  const pType = document.getElementById("pType");
  const btnAddPresent = document.getElementById("btnAddPresent");
  const btnClearPresent = document.getElementById("btnClearPresent");
  const presentList = document.getElementById("presentList");

  btnAddPresent.addEventListener("click", ()=>{
    const amount = Number(String(pAmount.value).replace(",", "."));
    const concept = String(pConcept.value||"").trim();
    const type = pType.value;

    if(!Number.isFinite(amount) || amount === 0) return;
    if(!concept) return;

    state.present.unshift(normalizeItem({ amount, concept, type, createdAt: nowISO() }));
    saveState();

    pAmount.value = "";
    pConcept.value = "";
    pType.value = "income";
    renderPresent();
  });

  btnClearPresent.addEventListener("click", ()=>{
    if(!state.present.length) return;
    openModal({
      title:"Limpiar",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øBorrar todos los movimientos?"; return d;})(),
      okText:"Borrar",
      cancelText:"Cancelar",
      onOk: ()=>{ state.present = []; saveState(); renderPresent(); return true; }
    });
  });

  function openMoveToSavingsModal(presentItem, onMoved){
    const max = Number(presentItem.amount || 0);
    const box = document.createElement("div");
    box.innerHTML = `<label>Cantidad a pasar a ahorro</label>`;
    const inp = document.createElement("input");
    inp.type = "number";
    inp.step = "0.01";
    inp.inputMode = "decimal";
    inp.min = "0";
    inp.max = String(max);
    inp.value = String(max);
    box.appendChild(inp);

    openModal({
      title: "Pasar a Ahorro",
      bodyNode: box,
      okText: "Mover",
      cancelText: "Cancelar",
      onOk: ()=>{
        const n = Number(String(inp.value).replace(",", "."));
        if(!Number.isFinite(n) || n <= 0){ inp.focus(); return false; }
        if(n > max){ inp.focus(); return false; }

        presentItem.amount = +(max - n).toFixed(2);
        if(presentItem.amount <= 0.000001){
          state.present = state.present.filter(x => x.id !== presentItem.id);
        }

        state.savings.unshift(normalizeItem({
          amount: +n.toFixed(2),
          concept: presentItem.concept,
          type: "income",
          createdAt: nowISO()
        }));

        saveState();
        onMoved();
        return true;
      }
    });
  }

  function renderPresent(){
    const { balance } = computeBalance(state.present);
    presentBalanceEl.textContent = fmtEUR(balance);

    presentList.innerHTML = "";
    state.present.forEach(it=>{
      presentList.appendChild(renderMovementRow(it, {
        onRefresh: renderPresent,
        onDelete: ()=>{ state.present = state.present.filter(x => x.id !== it.id); saveState(); renderPresent(); },
        showCoin: true,
        onCoin: ()=> openMoveToSavingsModal(it, ()=>{ renderPresent(); renderSavings(); })
      }));
    });
  }

  /* Archivar */
  const btnArchivarTopEl = document.getElementById("btnArchivarTop");
  btnArchivarTopEl.addEventListener("click", ()=>{
    if(!state.present.length) return;
    openTextModal({
      title:"Nombre del archivo",
      initialValue:"Archivo " + new Date().toLocaleDateString("es-ES"),
      okText:"Archivar",
      onOk:(name)=>{
        state.archives.unshift({ id: uid(), name, createdAt: nowISO(), items: state.present.map(x=>({ ...x })) });
        state.present = [];
        saveState();
        renderPresent();
        renderArchive();
      }
    });
  });

  /* =========================
     Ahorro
     ========================= */
  const savingsList = document.getElementById("savingsList");
  const savingsTotalEl = document.getElementById("savingsTotal");
  const btnClearSavings = document.getElementById("btnClearSavings");

  btnClearSavings.addEventListener("click", ()=>{
    if(!state.savings.length) return;
    openModal({
      title:"Limpiar",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øBorrar todos los movimientos de Ahorro?"; return d;})(),
      okText:"Borrar",
      cancelText:"Cancelar",
      onOk: ()=>{ state.savings = []; saveState(); renderSavings(); return true; }
    });
  });

  function renderSavings(){
    const total = state.savings.reduce((acc, it)=> acc + Number(it.amount||0), 0);
    savingsTotalEl.textContent = fmtEUR(total);

    savingsList.innerHTML = "";
    state.savings.forEach(it=>{
      savingsList.appendChild(renderMovementRow(it, {
        onRefresh: renderSavings,
        onDelete: ()=>{ state.savings = state.savings.filter(x => x.id !== it.id); saveState(); renderSavings(); },
        showCoin:false
      }));
    });
  }

  /* =========================
     ARCHIVO + PAPELERA + AGRUPAR
     ========================= */
  const archiveGroupsList = document.getElementById("archiveGroupsList");
  const archiveList = document.getElementById("archiveList");
  const trashList = document.getElementById("trashList");
  const btnTrashWipeAll = document.getElementById("btnTrashWipeAll");
  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");
  const importFile = document.getElementById("importFile");
  const btnGroupPuzzle = document.getElementById("btnGroupPuzzle");
  const selectedArchiveIds = new Set();

  function groupedIdSet(){
    const set = new Set();
    state.archiveGroups.forEach(g => g.archiveIds.forEach(id => set.add(id)));
    return set;
  }
  function removeArchiveIdFromGroups(archiveId){
    state.archiveGroups.forEach(g=>{
      g.archiveIds = g.archiveIds.filter(id => id !== archiveId);
    });
    state.archiveGroups = state.archiveGroups.filter(g => g.archiveIds.length > 0);
  }
  function moveArchiveToTrash(archive){
    removeArchiveIdFromGroups(archive.id);
    state.archives = state.archives.filter(a => a.id !== archive.id);
    state.trashArchives.unshift({ ...archive, deletedAt: nowISO() });
    saveState();
  }
  function permanentlyDeleteTrashArchive(trashId){
    state.trashArchives = state.trashArchives.filter(t => t.id !== trashId);
    saveState();
  }
  function openDeleteGroupModal(group){
    openModal({
      title:"Eliminar agrupaci√≥n",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent=`Se eliminar√° el grupo "${group.name}", pero los archivos seguir√°n existiendo. ¬øContinuar?`; return d;})(),
      okText:"Eliminar",
      cancelText:"Cancelar",
      onOk: ()=>{
        state.archiveGroups = state.archiveGroups.filter(g => g.id !== group.id);
        saveState();
        renderArchive();
        return true;
      }
    });
  }

  function renderTrash(){
    trashList.innerHTML = "";
    if(!state.trashArchives.length){
      const d = document.createElement("div");
      d.style.color = "var(--muted)";
      d.style.fontWeight = "800";
      d.style.fontSize = "13px";
      d.textContent = "Vac√≠a";
      trashList.appendChild(d);
      return;
    }
    state.trashArchives.forEach(t=>{
      const row = document.createElement("div");
      row.className = "trashRow";

      const left = document.createElement("div");
      left.style.minWidth = "0";
      left.style.flex = "1";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = t.name;

      const meta = document.createElement("div");
      meta.className = "meta";
      const when = (t.deletedAt || "").slice(0,10);
      meta.textContent = `Borrado: ${when || "-"}`;

      left.appendChild(name);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.alignItems = "center";

      const wipe = document.createElement("button");
      wipe.className = "iconBtn";
      wipe.title = "Borrar definitivamente";
      wipe.textContent = "üßΩ";
      wipe.addEventListener("click", ()=>{
        openModal({
          title:"Borrar definitivamente",
          bodyNode:(()=>{const d=document.createElement("div"); d.textContent=`Esto eliminar√° "${t.name}" para siempre. ¬øContinuar?`; return d;})(),
          okText:"Borrar",
          cancelText:"Cancelar",
          onOk: ()=>{
            permanentlyDeleteTrashArchive(t.id);
            renderTrash();
            return true;
          }
        });
      });

      right.appendChild(wipe);

      row.appendChild(left);
      row.appendChild(right);
      trashList.appendChild(row);
    });
  }

  btnTrashWipeAll.addEventListener("click", ()=>{
    if(!state.trashArchives.length) return;
    openModal({
      title:"Vaciar papelera",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent="Esto borrar√° definitivamente TODO lo que hay en la papelera. ¬øContinuar?"; return d;})(),
      okText:"Vaciar",
      cancelText:"Cancelar",
      onOk: ()=>{
        state.trashArchives = [];
        saveState();
        renderTrash();
        return true;
      }
    });
  });

  btnGroupPuzzle.addEventListener("click", ()=>{
    const ids = Array.from(selectedArchiveIds);
    if(ids.length < 2){
      const d = document.createElement("div");
      d.textContent = "Marca al menos 2 archivos para agrupar.";
      openModal({ title:"Agrupar", bodyNode:d, okText:"OK", cancelText:"", onOk: ()=>true });
      return;
    }
    openTextModal({
      title:"Nombre del grupo",
      initialValue: new Date().getFullYear().toString(),
      okText:"Crear grupo",
      onOk:(name)=>{
        state.archiveGroups.unshift({ id: uid(), name, archiveIds: ids, createdAt: nowISO() });
        selectedArchiveIds.clear();
        saveState();
        renderArchive();
      }
    });
  });

  function renderArchive(){
    archiveGroupsList.innerHTML = "";
    archiveList.innerHTML = "";

    const gSet = groupedIdSet();

    state.archiveGroups.forEach(group=>{
      const det = document.createElement("details");
      det.className = "archive";

      const sum = document.createElement("summary");

      const left = document.createElement("div");
      left.className = "archiveTitle";

      const nameSpan = document.createElement("span");
      nameSpan.textContent = group.name;

      left.appendChild(nameSpan);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.alignItems = "center";

      const rename = document.createElement("button");
      rename.className = "iconBtn";
      rename.title = "Renombrar grupo";
      rename.textContent = "‚úèÔ∏è";
      rename.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        openTextModal({
          title:"Renombrar grupo",
          initialValue: group.name,
          okText:"Guardar",
          onOk:(newName)=>{
            group.name = newName;
            saveState();
            renderArchive();
          }
        });
      });

      const delGroup = document.createElement("button");
      delGroup.className = "iconBtn danger";
      delGroup.title = "Eliminar agrupaci√≥n";
      delGroup.textContent = "üóëÔ∏è";
      delGroup.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        openDeleteGroupModal(group);
      });

      right.appendChild(rename);
      right.appendChild(delGroup);

      sum.appendChild(left);
      sum.appendChild(right);
      det.appendChild(sum);

      const inner = document.createElement("div");
      inner.style.marginTop = "10px";
      inner.style.display = "flex";
      inner.style.flexDirection = "column";
      inner.style.gap = "8px";

      group.archiveIds.forEach(aid=>{
        const arch = state.archives.find(a => a.id === aid);
        if(!arch) return;

        const aDet = document.createElement("details");
        aDet.className = "archive";

        const aSum = document.createElement("summary");

        const aLeft = document.createElement("div");
        aLeft.className = "archiveTitle";

        const aName = document.createElement("span");
        aName.textContent = arch.name;

        aLeft.appendChild(aName);

        const aRight = document.createElement("div");
        aRight.style.display = "flex";
        aRight.style.gap = "8px";
        aRight.style.alignItems = "center";

        const aRename = document.createElement("button");
        aRename.className = "iconBtn";
        aRename.textContent = "‚úèÔ∏è";
        aRename.title = "Renombrar archivo";
        aRename.addEventListener("click", (e)=>{
          e.preventDefault(); e.stopPropagation();
          openTextModal({
            title:"Renombrar archivo",
            initialValue: arch.name,
            okText:"Guardar",
            onOk:(newName)=>{
              arch.name = newName;
              saveState();
              renderArchive();
            }
          });
        });

        const aDel = document.createElement("button");
        aDel.className = "iconBtn danger";
        aDel.textContent = "üóëÔ∏è";
        aDel.title = "Borrar (a papelera)";
        aDel.addEventListener("click", (e)=>{
          e.preventDefault(); e.stopPropagation();
          openModal({
            title:"Borrar archivo",
            bodyNode:(()=>{const d=document.createElement("div"); d.textContent=`¬øSeguro que quieres borrar "${arch.name}"? Se enviar√° a la papelera.`; return d;})(),
            okText:"Borrar",
            cancelText:"Cancelar",
            onOk: ()=>{
              moveArchiveToTrash(arch);
              renderArchive();
              renderTrash();
              return true;
            }
          });
        });

        aRight.appendChild(aRename);
        aRight.appendChild(aDel);

        aSum.appendChild(aLeft);
        aSum.appendChild(aRight);
        aDet.appendChild(aSum);

        const itemsWrap = document.createElement("div");
        itemsWrap.style.marginTop = "10px";
        itemsWrap.style.display = "flex";
        itemsWrap.style.flexDirection = "column";
        itemsWrap.style.gap = "8px";

        (arch.items||[]).forEach(it=>{
          itemsWrap.appendChild(renderMovementRow(it, {
            onRefresh: renderArchive,
            onDelete: ()=>{
              arch.items = arch.items.filter(x => x.id !== it.id);
              saveState();
              renderArchive();
            }
          }));
        });

        aDet.appendChild(itemsWrap);
        inner.appendChild(aDet);
      });

      det.appendChild(inner);
      archiveGroupsList.appendChild(det);
    });

    state.archives.forEach(arch=>{
      if(gSet.has(arch.id)) return;

      const det = document.createElement("details");
      det.className = "archive";

      const sum = document.createElement("summary");

      const left = document.createElement("div");
      left.className = "archiveTitle";

      const chkWrap = document.createElement("label");
      chkWrap.className = "archiveChk";
      chkWrap.title = "Marcar para agrupar";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selectedArchiveIds.has(arch.id);
      cb.addEventListener("click", (e)=> e.stopPropagation());
      cb.addEventListener("change", ()=>{
        if(cb.checked) selectedArchiveIds.add(arch.id);
        else selectedArchiveIds.delete(arch.id);
      });
      chkWrap.appendChild(cb);

      const nameSpan = document.createElement("span");
      nameSpan.textContent = arch.name;

      const renameBtn = document.createElement("button");
      renameBtn.className = "iconBtn";
      renameBtn.textContent = "‚úèÔ∏è";
      renameBtn.title = "Renombrar";
      renameBtn.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        openTextModal({
          title:"Renombrar archivo",
          initialValue: arch.name,
          okText:"Guardar",
          onOk:(newName)=>{ arch.name = newName; saveState(); renderArchive(); }
        });
      });

      left.appendChild(chkWrap);
      left.appendChild(nameSpan);
      left.appendChild(renameBtn);

      const right = document.createElement("div");
      const delBtn = document.createElement("button");
      delBtn.className = "iconBtn danger";
      delBtn.textContent = "üóëÔ∏è";
      delBtn.title = "Borrar (a papelera)";
      delBtn.addEventListener("click", (e)=>{
        e.preventDefault
        e.preventDefault(); e.stopPropagation();
        openModal({
          title:"Borrar archivo",
          bodyNode:(()=>{const d=document.createElement("div"); d.textContent=`¬øSeguro que quieres borrar "${arch.name}"? Se enviar√° a la papelera.`; return d;})(),
          okText:"Borrar",
          cancelText:"Cancelar",
          onOk: ()=>{
            moveArchiveToTrash(arch);
            renderArchive();
            renderTrash();
            return true;
          }
        });
      });
      right.appendChild(delBtn);

      sum.appendChild(left);
      sum.appendChild(right);
      det.appendChild(sum);

      const inner = document.createElement("div");
      inner.style.marginTop = "10px";
      inner.style.display = "flex";
      inner.style.flexDirection = "column";
      inner.style.gap = "8px";

      (arch.items || []).forEach(it=>{
        inner.appendChild(renderMovementRow(it, {
          onRefresh: renderArchive,
          onDelete: ()=>{
            arch.items = arch.items.filter(x => x.id !== it.id);
            saveState();
            renderArchive();
          }
        }));
      });

      det.appendChild(inner);
      archiveList.appendChild(det);
    });

    renderTrash();
  }

  btnExport.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "financium_backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  btnImport.addEventListener("click", ()=> importFile.click());
  importFile.addEventListener("change", async ()=>{
    const file = importFile.files && importFile.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const parsed = JSON.parse(text);
      openModal({
        title:"Importar",
        bodyNode:(()=>{const d=document.createElement("div"); d.textContent="Esto reemplaza tus datos. ¬øContinuar?"; return d;})(),
        okText:"Importar",
        cancelText:"Cancelar",
        onOk: ()=>{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
          location.reload();
          return true;
        }
      });
    }catch(e){}
    finally{ importFile.value = ""; }
  });

  /* =========================
     Forecast
     ========================= */
  function ensureYearContainers(year){
    if(!state.forecast[year]) state.forecast[year] = {};
    if(!state.monthColors[year]) state.monthColors[year] = {};
  }
  function getForecastMonthItems(year, monthIndex){
    ensureYearContainers(year);
    if(!Array.isArray(state.forecast[year][monthIndex])) state.forecast[year][monthIndex] = [];
    return state.forecast[year][monthIndex];
  }
  function getMonthColor(year, monthIndex){
    ensureYearContainers(year);
    return state.monthColors[year][monthIndex] || "#ffffff";
  }
  function setMonthColor(year, monthIndex, color){
    ensureYearContainers(year);
    state.monthColors[year][monthIndex] = color;
    saveState();
  }

  function openColorPicker({ title, onPick }){
    const box = document.createElement("div");
    box.innerHTML = `<label>Elige un color</label>`;

    const colors = [
      {c:"#ffffff", t:"‚Äî"},
      {c:"#eaf2ff", t:"Azul"},
      {c:"#d1fae5", t:"Verde"},
      {c:"#fee2e2", t:"Rojo"},
      {c:"#fef3c7", t:"Amarillo"},
      {c:"#e9d5ff", t:"Lila"},
      {c:"#cffafe", t:"Turq"},
      {c:"#fce7f3", t:"Rosa"},
      {c:"#e5e7eb", t:"Gris"},
      {c:"#111827", t:"Negro"}
    ];

    const grid = document.createElement("div");
    grid.className = "colorGrid";

    colors.forEach(o=>{
      const sw = document.createElement("button");
      sw.type = "button";
      sw.className = "colorSwatch";
      sw.style.background = o.c;
      sw.style.color = (o.c === "#111827") ? "#fff" : "#0b2a5a";
      sw.textContent = o.t;
      sw.addEventListener("click", ()=>{
        onPick(o.c);
        closeModal();
      });
      grid.appendChild(sw);
    });

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.textContent = "Se guarda autom√°ticamente.";

    box.appendChild(grid);
    box.appendChild(hint);

    openModal({ title, bodyNode: box, okText:"", cancelText:"", onOk: ()=>true });
  }

  const yearLabel = document.getElementById("yearLabel");
  const yearBalanceEl = document.getElementById("yearBalance");
  const monthsGrid = document.getElementById("monthsGrid");

  function renderForecast(){
    const year = new Date().getFullYear();
    ensureYearContainers(year);
    yearLabel.textContent = year;

    let annual = 0;
    for(let m=0; m<12; m++){
      const items = getForecastMonthItems(year, m);
      annual += computeBalance(items).balance;
    }
    yearBalanceEl.textContent = fmtEUR(annual);

    monthsGrid.innerHTML = "";
    for(let m=0; m<12; m++){
      const items = getForecastMonthItems(year, m);
      const { balance } = computeBalance(items);

      const card = document.createElement("div");
      card.className = "month";
      card.style.background = getMonthColor(year, m);

      const tools = document.createElement("div");
      tools.className = "monthTools";
      const paint = document.createElement("button");
      paint.type = "button";
      paint.textContent = "üé®";
      paint.title = "Color del mes";
      paint.addEventListener("click", (e)=>{
        e.stopPropagation();
        openColorPicker({
          title: `Color: ${MONTHS_ES[m]}`,
          onPick: (c)=>{ setMonthColor(year, m, c); renderForecast(); }
        });
      });
      tools.appendChild(paint);
      card.appendChild(tools);

      const name = document.createElement("div");
      name.className = "monthName";
      name.textContent = MONTHS_ES[m];

      const bal = document.createElement("div");
      bal.className = "monthBal";
      bal.textContent = fmtEUR(balance);

      card.appendChild(name);
      card.appendChild(bal);

      card.addEventListener("click", ()=>{
        currentForecastMonth = { year, monthIndex: m };
        showPage("forecastMonth");
      });

      monthsGrid.appendChild(card);
    }
  }

  const monthTitle = document.getElementById("monthTitle");
  const btnBackForecast = document.getElementById("btnBackForecast");
  const btnMonthColor = document.getElementById("btnMonthColor");
  const fAmount = document.getElementById("fAmount");
  const fConcept = document.getElementById("fConcept");
  const fType = document.getElementById("fType");
  const btnAddForecast = document.getElementById("btnAddForecast");
  const btnClearForecastMonth = document.getElementById("btnClearForecastMonth");
  const forecastMonthList = document.getElementById("forecastMonthList");

  btnBackForecast.addEventListener("click", ()=> showPage("forecast"));

  btnMonthColor.addEventListener("click", ()=>{
    if(!currentForecastMonth) return;
    const { year, monthIndex } = currentForecastMonth;
    openColorPicker({
      title: `Color: ${MONTHS_ES[monthIndex]}`,
      onPick: (c)=>{ setMonthColor(year, monthIndex, c); renderForecast(); }
    });
  });

  btnAddForecast.addEventListener("click", ()=>{
    if(!currentForecastMonth) return;

    const amount = Number(String(fAmount.value).replace(",", "."));
    const concept = String(fConcept.value||"").trim();
    const type = fType.value;

    if(!Number.isFinite(amount) || amount === 0) return;
    if(!concept) return;

    const items = getForecastMonthItems(currentForecastMonth.year, currentForecastMonth.monthIndex);
    items.unshift(normalizeItem({ amount, concept, type, createdAt: nowISO() }));
    saveState();

    fAmount.value=""; fConcept.value=""; fType.value="income";
    renderForecastMonth();
    renderForecast();
  });

  btnClearForecastMonth.addEventListener("click", ()=>{
    if(!currentForecastMonth) return;
    const items = getForecastMonthItems(currentForecastMonth.year, currentForecastMonth.monthIndex);
    if(!items.length) return;

    openModal({
      title:"Limpiar",
      bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øBorrar todos los movimientos del mes?"; return d;})(),
      okText:"Borrar",
      cancelText:"Cancelar",
      onOk: ()=>{
        state.forecast[currentForecastMonth.year][currentForecastMonth.monthIndex] = [];
        saveState();
        renderForecastMonth(); renderForecast();
        return true;
      }
    });
  });

  function renderForecastMonth(){
    if(!currentForecastMonth){ showPage("forecast"); return; }
    const { year, monthIndex } = currentForecastMonth;
    const items = getForecastMonthItems(year, monthIndex);
    monthTitle.textContent = `${MONTHS_ES[monthIndex]} ${year}`;

    forecastMonthList.innerHTML = "";
    items.forEach(it=>{
      forecastMonthList.appendChild(renderMovementRow(it, {
        onRefresh: ()=>{ saveState(); renderForecastMonth(); renderForecast(); },
        onDelete: ()=>{ state.forecast[year][monthIndex] = items.filter(x => x.id !== it.id); saveState(); renderForecastMonth(); renderForecast(); },
        showCoin:false
      }));
    });
  }

  /* =========================
     DEUDAS (hub + nueva + activas + pagadas)
     ========================= */
  const debtsHub = document.getElementById("debtsHub");
  const debtsNew = document.getElementById("debtsNew");
  const debtsActive = document.getElementById("debtsActive");
  const debtsPaid = document.getElementById("debtsPaid");

  const goNewDebt = document.getElementById("goNewDebt");
  const goActiveDebts = document.getElementById("goActiveDebts");
  const goPaidDebts = document.getElementById("goPaidDebts");

  const backDebtsFromNew = document.getElementById("backDebtsFromNew");
  const backDebtsFromActive = document.getElementById("backDebtsFromActive");
  const backDebtsFromPaid = document.getElementById("backDebtsFromPaid");

  const activeCountEl = document.getElementById("activeCount");
  const paidCountEl = document.getElementById("paidCount");

  const dEntity = document.getElementById("dEntity");
  const dTotal = document.getElementById("dTotal");
  const dNote = document.getElementById("dNote");
  const btnAddDebt = document.getElementById("btnAddDebt");

  const debtSearch = document.getElementById("debtSearch");
  const debtSort = document.getElementById("debtSort");
  const debtsActiveList = document.getElementById("debtsActiveList");
  const debtsPaidList = document.getElementById("debtsPaidList");

  function showDebtsSection(which){
    debtsHub.style.display = (which === "hub") ? "block" : "none";
    debtsNew.style.display = (which === "new") ? "block" : "none";
    debtsActive.style.display = (which === "active") ? "block" : "none";
    debtsPaid.style.display = (which === "paid") ? "block" : "none";
  }

  function renderDebtsHub(){
    activeCountEl.textContent = `${state.debts.active.length} activas`;
    paidCountEl.textContent = `${state.debts.paid.length} pagadas`;
    showDebtsSection("hub");
  }

  goNewDebt.addEventListener("click", ()=>{ showDebtsSection("new"); });
  goActiveDebts.addEventListener("click", ()=>{ showDebtsSection("active"); renderDebtsActive(); });
  goPaidDebts.addEventListener("click", ()=>{ showDebtsSection("paid"); renderDebtsPaid(); });

  backDebtsFromNew.addEventListener("click", renderDebtsHub);
  backDebtsFromActive.addEventListener("click", renderDebtsHub);
  backDebtsFromPaid.addEventListener("click", renderDebtsHub);

  function openAddPaymentModal(debt){
    const box = document.createElement("div");

    const r = document.createElement("div");
    r.className = "row";

    const a = document.createElement("div");
    a.innerHTML = `<label>Cantidad pagada</label>`;
    const inpAmount = document.createElement("input");
    inpAmount.type = "number";
    inpAmount.step = "0.01";
    inpAmount.inputMode = "decimal";
    inpAmount.value = String(Math.min(debt.remaining, debt.total) || 0);
    a.appendChild(inpAmount);

    const b = document.createElement("div");
    b.innerHTML = `<label>Fecha</label>`;
    const inpDate = document.createElement("input");
    inpDate.type = "date";
    inpDate.value = todayISODate();
    b.appendChild(inpDate);

    r.appendChild(a);
    r.appendChild(b);

    box.appendChild(r);

    openModal({
      title: "A√±adir pago",
      bodyNode: box,
      okText: "Guardar",
      cancelText: "Cancelar",
      onOk: ()=>{
        const amt = Number(String(inpAmount.value).replace(",", "."));
        const date = String(inpDate.value||"").trim();
        if(!Number.isFinite(amt) || amt <= 0){ inpAmount.focus(); return false; }
        if(amt > debt.remaining + 0.000001){ inpAmount.focus(); return false; }
        if(!date){ inpDate.focus(); return false; }

        debt.payments.unshift({
          id: uid(),
          amount: +amt.toFixed(2),
          date,
          createdAt: nowISO()
        });
        debt.remaining = +(Math.max(0, debt.remaining - amt)).toFixed(2);

        if(debt.remaining <= 0.000001){
          state.debts.active = state.debts.active.filter(x => x.id !== debt.id);
          state.debts.paid.unshift(debt);
        }

        saveState();
        renderDebtsActive();
        renderDebtsHub();
        return true;
      }
    });
  }

  function moveDebtUp(debtId){
    const idx = state.debts.active.findIndex(d => d.id === debtId);
    if(idx <= 0) return;
    const arr = state.debts.active;
    [arr[idx-1], arr[idx]] = [arr[idx], arr[idx-1]];
    saveState();
    renderDebtsActive();
  }
  function moveDebtDown(debtId){
    const idx = state.debts.active.findIndex(d => d.id === debtId);
    if(idx < 0 || idx >= state.debts.active.length - 1) return;
    const arr = state.debts.active;
    [arr[idx+1], arr[idx]] = [arr[idx], arr[idx+1]];
    saveState();
    renderDebtsActive();
  }

  function renderDebtsActive(){
    const q = String(debtSearch.value || "").trim().toLowerCase();
    const mode = debtSort.value || "manual";

    let list = state.debts.active.slice();

    if(q){
      list = list.filter(d => (d.entity || "").toLowerCase().includes(q));
    }

    if(mode === "az"){
      list.sort((a,b)=> (a.entity||"").localeCompare(b.entity||"", "es", { sensitivity:"base" }));
    }else if(mode === "total_desc"){
      list.sort((a,b)=> (Number(b.total||0) - Number(a.total||0)));
    }else if(mode === "total_asc"){
      list.sort((a,b)=> (Number(a.total||0) - Number(b.total||0)));
    }

    debtsActiveList.innerHTML = "";

    if(!list.length){
      const d = document.createElement("div");
      d.style.color = "var(--muted)";
      d.style.fontWeight = "900";
      d.style.fontSize = "13px";
      d.textContent = "No hay resultados.";
      debtsActiveList.appendChild(d);
      return;
    }

    list.forEach(debt=>{
      const det = document.createElement("details");
      det.className = "debtCompact";

      const sum = document.createElement("summary");

      const left = document.createElement("div");
      left.className = "debtRowLeft";

      const name = document.createElement("div");
      name.className = "debtName";
      name.textContent = debt.entity || "Deuda";

      const line = document.createElement("div");
      line.className = "debtLine";
      line.innerHTML = `
        <span class="tag">Total: ${fmtEUR(debt.total)}</span>
        <span class="tag">Queda: ${fmtEUR(debt.remaining)}</span>
        <span class="tag">Pagos: ${Array.isArray(debt.payments)? debt.payments.length : 0}</span>
      `;

      left.appendChild(name);
      left.appendChild(line);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.alignItems = "center";

      const up = document.createElement("button");
      up.className = "iconBtn";
      up.title = "Subir";
      up.textContent = "‚Üë";
      up.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); moveDebtUp(debt.id); });

      const down = document.createElement("button");
      down.className = "iconBtn";
      down.title = "Bajar";
      down.textContent = "‚Üì";
      down.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); moveDebtDown(debt.id); });

      if(mode !== "manual"){
        up.style.display = "none";
        down.style.display = "none";
      }

      const payBtn = document.createElement("button");
      payBtn.className = "iconBtn";
      payBtn.title = "A√±adir pago";
      payBtn.textContent = "‚ûñ";
      payBtn.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); openAddPaymentModal(debt); });

      const editBtn = document.createElement("button");
      editBtn.className = "iconBtn";
      editBtn.title = "Editar datos";
      editBtn.textContent = "‚úèÔ∏è";
      editBtn.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        const box = document.createElement("div");
        const row = document.createElement("div");
        row.className = "row";

        const a = document.createElement("div");
        a.innerHTML = `<label>Persona / Entidad</label>`;
        const iEntity = document.createElement("input");
        iEntity.type="text"; iEntity.value = debt.entity || "";
        a.appendChild(iEntity);

        const b = document.createElement("div");
        b.innerHTML = `<label>Total</label>`;
        const iTotal = document.createElement("input");
        iTotal.type="number"; iTotal.step="0.01"; iTotal.inputMode="decimal";
        iTotal.value = String(debt.total ?? 0);
        b.appendChild(iTotal);

        const c = document.createElement("div");
        c.style.flex="1 1 100%";
        c.innerHTML = `<label>Nota / Asunto</label>`;
        const iNote = document.createElement("textarea");
        iNote.value = debt.note || "";
        c.appendChild(iNote);

        row.appendChild(a); row.appendChild(b); row.appendChild(c);
        box.appendChild(row);

        openModal({
          title:"Editar deuda",
          bodyNode: box,
          okText:"Guardar",
          cancelText:"Cancelar",
          onOk: ()=>{
            const ent = String(iEntity.value||"").trim();
            const tot = Number(String(iTotal.value).replace(",", "."));
            const note = String(iNote.value||"");

            if(!ent){ iEntity.focus(); return false; }
            if(!Number.isFinite(tot) || tot < 0){ iTotal.focus(); return false; }

            const paid = Math.max(0, Number(debt.total||0) - Number(debt.remaining||0));
            debt.entity = ent;
            debt.total = +tot.toFixed(2);
            debt.note = note;

            debt.remaining = +(Math.max(0, debt.total - paid)).toFixed(2);

            if(debt.remaining <= 0.000001){
              state.debts.active = state.debts.active.filter(x => x.id !== debt.id);
              state.debts.paid.unshift(debt);
            }

            saveState();
            renderDebtsActive();
            renderDebtsHub();
            return true;
          }
        });
      });

      const delBtn = document.createElement("button");
      delBtn.className = "iconBtn danger";
      delBtn.title = "Borrar deuda";
      delBtn.textContent = "üóëÔ∏è";
      delBtn.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        openModal({
          title:"Borrar deuda",
          bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øSeguro?"; return d;})(),
          okText:"Borrar",
          cancelText:"Cancelar",
          onOk: ()=>{
            state.debts.active = state.debts.active.filter(x => x.id !== debt.id);
            saveState();
            renderDebtsActive();
            renderDebtsHub();
            return true;
          }
        });
      });

      right.appendChild(up);
      right.appendChild(down);
      right.appendChild(payBtn);
      right.appendChild(editBtn);
      right.appendChild(delBtn);

      sum.appendChild(left);
      sum.appendChild(right);

      det.appendChild(sum);

      const body = document.createElement("div");
      body.style.marginTop = "10px";

      if(debt.note && String(debt.note).trim()){
        const note = document.createElement("div");
        note.style.fontSize = "12px";
        note.style.fontWeight = "900";
        note.style.opacity = ".9";
        note.style.marginBottom = "10px";
        note.textContent = debt.note;
        body.appendChild(note);
      }

      const logTitle = document.createElement("div");
      logTitle.style.fontWeight = "1000";
      logTitle.style.color = "var(--blue-900)";
      logTitle.style.fontSize = "13px";
      logTitle.style.marginBottom = "8px";
      logTitle.textContent = "Pagos";

      body.appendChild(logTitle);

      const log = document.createElement("div");
      log.className = "payLog";

      const payments = Array.isArray(debt.payments) ? debt.payments.slice() : [];
      if(!payments.length){
        const none = document.createElement("div");
        none.style.color = "var(--muted)";
        none.style.fontWeight = "900";
        none.style.fontSize = "12px";
        none.textContent = "A√∫n no hay pagos.";
        log.appendChild(none);
      }else{
        payments.sort((a,b)=>{
          const da = a.date || "";
          const db = b.date || "";
          if(da && db && da !== db) return db.localeCompare(da);
          return (b.createdAt||"").localeCompare(a.createdAt||"");
        });

        payments.forEach(p=>{
          const entry = document.createElement("div");
          entry.className = "payEntry";

          const l = document.createElement("div");
          l.className = "l";
          const ds = p.date ? p.date : "-";
          l.innerHTML = `<span class="tag">${ds}</span><span class="tag">${fmtEUR(p.amount)}</span>`;

          const r = document.createElement("div");
          r.className = "r";

          const delPay = document.createElement("button");
          delPay.className = "iconBtn danger";
          delPay.title = "Borrar pago";
          delPay.textContent = "üóëÔ∏è";
          delPay.addEventListener("click", ()=>{
            openModal({
              title:"Borrar pago",
              bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øSeguro? (Se devolver√° al 'queda')"; return d;})(),
              okText:"Borrar",
              cancelText:"Cancelar",
              onOk: ()=>{
                debt.payments = debt.payments.filter(x => x.id !== p.id);
                debt.remaining = +(Math.max(0, Number(debt.remaining||0) + Number(p.amount||0))).toFixed(2);
                saveState();
                renderDebtsActive();
                renderDebtsHub();
                return true;
              }
            });
          });

          r.appendChild(delPay);

          entry.appendChild(l);
          entry.appendChild(r);
          log.appendChild(entry);
        });
      }

      body.appendChild(log);
      det.appendChild(body);

      debtsActiveList.appendChild(det);
    });
  }

  debtSearch.addEventListener("input", renderDebtsActive);
  debtSort.addEventListener("change", renderDebtsActive);

  btnAddDebt.addEventListener("click", ()=>{
    const entity = String(dEntity.value||"").trim();
    const total = Number(String(dTotal.value).replace(",", "."));
    const note = String(dNote.value||"");

    if(!entity) return;
    if(!Number.isFinite(total) || total <= 0) return;

    state.debts.active.unshift(normalizeDebtNew({
      entity,
      total: +total.toFixed(2),
      remaining: +total.toFixed(2),
      note,
      payments: [],
      createdAt: nowISO(),
      order: Date.now()
    }));

    saveState();

    dEntity.value = "";
    dTotal.value = "";
    dNote.value = "";

    renderDebtsHub();
  });

  function renderDebtsPaid(){
    debtsPaidList.innerHTML = "";
    if(!state.debts.paid.length){
      const d = document.createElement("div");
      d.style.color = "var(--muted)";
      d.style.fontWeight = "900";
      d.style.fontSize = "13px";
      d.textContent = "A√∫n no hay deudas pagadas.";
      debtsPaidList.appendChild(d);
      return;
    }

    state.debts.paid.forEach(debt=>{
      const row = document.createElement("div");
      row.className = "paidCompact";

      const left = document.createElement("div");
      left.className = "left";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = debt.entity || "Deuda pagada";

      const small = document.createElement("div");
      small.className = "small";
      small.innerHTML = `
        <span>Total: ${fmtEUR(debt.total)}</span>
        <span>Pagos: ${Array.isArray(debt.payments)? debt.payments.length : 0}</span>
      `;

      left.appendChild(name);
      left.appendChild(small);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.alignItems = "center";

      const del = document.createElement("button");
      del.className = "iconBtn danger";
      del.title = "Borrar";
      del.textContent = "üóëÔ∏è";
      del.addEventListener("click", ()=>{
        openModal({
          title:"Borrar deuda pagada",
          bodyNode:(()=>{const d=document.createElement("div"); d.textContent="¬øSeguro?"; return d;})(),
          okText:"Borrar",
          cancelText:"Cancelar",
          onOk: ()=>{
            state.debts.paid = state.debts.paid.filter(x => x.id !== debt.id);
            saveState();
            renderDebtsPaid();
            renderDebtsHub();
            return true;
          }
        });
      });

      right.appendChild(del);

      row.appendChild(left);
      row.appendChild(right);

      debtsPaidList.appendChild(row);
    });
  }

  /* Init */
  showPage("home");
  renderPresent();
  renderSavings();
  renderArchive();
  renderForecast();
  renderDebtsHub();
</script>
</body>
</html>